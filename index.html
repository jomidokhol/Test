<!DOCTYPE html>
<html lang="bn" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4e73df;
            --sidebar-width: 260px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Poppins', 'Hind Siliguri', sans-serif;
            background-color: var(--bs-body-bg);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
            margin: 0;
        }

        /* --- Login Screen Styling --- */
        .login-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            transition: all 0.5s ease;
        }
        .login-card {
            width: 100%; max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideUp 0.5s ease;
        }

        /* --- Layout Structure --- */
        .d-flex-wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh;
            align-items: stretch;
            position: relative;
        }

        /* --- Sidebar --- */
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: #2c3e50;
            color: #fff;
            height: 100vh;
            transition: all var(--transition-speed);
            z-index: 1050;
            position: fixed;
            top: 0; left: 0;
            overflow-y: auto;
            margin-left: calc(var(--sidebar-width) * -1); /* Hidden initially */
        }
        
        #sidebar.active {
            margin-left: 0; /* Show sidebar */
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            text-align: center;
            font-weight: 600;
            font-size: 1.3rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #sidebar ul.components {
            padding: 20px 0;
            list-style: none;
            margin: 0;
        }

        #sidebar ul li a {
            padding: 15px 25px;
            font-size: 0.95rem;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        #sidebar ul li a:hover, #sidebar ul li a.active-link {
            color: #fff;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary-color);
            padding-left: 30px;
        }

        /* --- Content Area --- */
        #content {
            width: 100%;
            margin-left: 0;
            transition: all var(--transition-speed);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.5); 
            z-index: 1040;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.show { display: block; }

        /* --- Top Navigation Bar --- */
        .navbar {
            padding: 15px 25px;
            background: var(--bs-body-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--bs-border-color);
        }

        .main-content {
            padding: 30px;
            flex: 1;
        }

        /* --- Cards & Tables --- */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.03);
            transition: transform 0.2s;
            margin-bottom: 24px;
        }
        
        .stat-card { border-left: 5px solid; }

        /* --- Animations --- */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading Spinner */
        #loadingSpinner {
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 3000;
        }

        /* Small item styling for list */
        .list-item-img {
            width: 40px; height: 40px; object-fit: cover; border-radius: 50%;
        }
        
        /* Action buttons in tables */
        .action-btn {
            cursor: pointer;
            margin-left: 5px;
        }

        /* Contact List Slider Styles */
        .cl-slider-container {
            width: 500%; /* 5 steps */
            display: flex;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            height: 100%;
        }
        .cl-slide {
            width: 20%; /* 100% / 5 */
            flex-shrink: 0;
            padding: 10px;
            height: 100%;
            overflow-y: auto;
            position: relative;
        }
        .cl-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--bs-border-color);
        }
        .cl-item:hover {
            background-color: var(--bs-tertiary-bg);
            transform: translateX(5px);
            border-color: var(--primary-color);
        }
        
        /* Floating Action Button */
        .fab-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: transform 0.2s;
        }
        .fab-btn:hover {
            transform: scale(1.1);
            background-color: #375ac7;
        }

        /* Modal Details Styling */
        #applicationDetailsBody p {
            margin-bottom: 0.5rem;
        }
        #applicationDetailsBody strong {
            display: inline-block;
            min-width: 100px;
            color: var(--bs-secondary-color);
        }

    </style>
</head>
<body>

    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 1. Login Screen -->
    <div id="loginSection" class="login-wrapper">
        <div class="card login-card p-5 bg-white text-dark">
            <div class="text-center mb-4">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; font-size: 24px;">
                    <i class="fas fa-fire"></i>
                </div>
                <h3>এডমিন প্যানেল</h3>
                <p class="text-muted small">এডমিন নিরাপদ লগইন</p>
            </div>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="adminEmail" placeholder="name@example.com">
                <label for="adminEmail">ইমেইল এড্রেস</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="adminPass" placeholder="password">
                <label for="adminPass">পাসওয়ার্ড</label>
            </div>
            <button id="btnLogin" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">প্রবেশ করুন</button>
            <small class="text-danger text-center mt-3 d-block" id="loginError"></small>
        </div>
    </div>

    <!-- Overlay -->
    <div class="sidebar-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <!-- 2. Main Application Wrapper -->
    <div class="d-flex-wrapper d-none" id="mainApp">
        
        <!-- SIDEBAR MENU -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-rocket me-2"></i> সাইট মেনু
            </div>
            <ul class="components">
                <li><a href="#" onclick="showPage('dashboard', this)" class="active-link"><i class="fas fa-home me-3"></i>ড্যাশবোর্ড</a></li>
                <li><a href="#" onclick="showPage('general', this)"><i class="fas fa-sliders-h me-3"></i>হোম কনফিগার</a></li>
                <li><a href="#" onclick="showPage('userlist', this)"><i class="fas fa-users me-3"></i>ইউজার লিস্ট</a></li>
                <li><a href="#" onclick="showPage('contactlist', this)"><i class="fas fa-address-book me-3"></i>কন্টাক্ট লিস্ট</a></li>
                <li><a href="#" onclick="showPage('about', this)"><i class="fas fa-info-circle me-3"></i>আমাদের সম্পর্কে</a></li>
                <li><a href="#" onclick="showPage('contact', this)"><i class="fas fa-address-card me-3"></i>যোগাযোগ তথ্য</a></li>
                <li><a href="#" onclick="showPage('updates', this)"><i class="fas fa-bullhorn me-3"></i>নিউজ আপডেট</a></li>
                <li><a href="#" onclick="showPage('newadmin', this)"><i class="fas fa-user-plus me-3"></i>নিউ এডমিন</a></li>
                <li><a href="#" onclick="showPage('settings', this)"><i class="fas fa-cog me-3"></i>সেটিংস</a></li>
            </ul>
            <div class="text-center mt-5">
                <button id="btnLogout" class="btn btn-danger btn-sm w-75 rounded-pill"><i class="fas fa-sign-out-alt me-2"></i>লগ আউট</button>
            </div>
        </nav>

        <!-- CONTENT AREA -->
        <div id="content">
            
            <!-- TOP MENU BAR -->
            <nav class="navbar navbar-expand-lg sticky-top">
                <div class="container-fluid">
                    <!-- Toggle Button (Hamburger) -->
                    <button type="button" id="sidebarCollapse" class="btn btn-primary shadow-sm" onclick="toggleSidebar()">
                        <i class="fas fa-bars me-1"></i> <span class="d-none d-sm-inline">মেনু</span>
                    </button>
                    
                    <div class="d-flex align-items-center ms-auto">
                        <button class="btn btn-outline-secondary border-0 me-3" onclick="toggleTheme()" id="themeBtn" title="Change Theme">
                            <i class="fas fa-moon"></i>
                        </button>
                        
                        <div class="dropdown">
                            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-body" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="https://ui-avatars.com/api/?name=Admin&background=4e73df&color=fff" alt="" width="40" height="40" class="rounded-circle me-2 border">
                                <span class="fw-bold small d-none d-sm-inline" id="displayUsername">Admin</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item" href="#" onclick="showPage('settings')"><i class="fas fa-user me-2"></i>প্রোফাইল</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Dynamic Content -->
            <div class="main-content">
                
                <!-- Dashboard Section -->
                <div id="dashboard" class="page-section fade-in">
                    <h4 class="mb-4 text-muted border-bottom pb-2">ড্যাশবোর্ড ওভারভিউ</h4>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="card stat-card p-4 border-primary bg-body-tertiary">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted text-uppercase mb-2">মোট ইউজার</h6>
                                        <h2 class="mb-0 fw-bold" id="totalUsersCount">0</h2>
                                    </div>
                                    <div class="fs-1 text-primary opacity-25"><i class="fas fa-users"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card p-4 border-success bg-body-tertiary">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted text-uppercase mb-2">সর্বমোট নিউজ</h6>
                                        <h2 class="mb-0 fw-bold" id="totalNewsCount">0</h2>
                                    </div>
                                    <div class="fs-1 text-success opacity-25"><i class="fas fa-newspaper"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stat-card p-4 border-warning bg-body-tertiary">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted text-uppercase mb-2">টিম মেম্বার</h6>
                                        <h2 class="mb-0 fw-bold" id="totalTeamCount">0</h2>
                                    </div>
                                    <div class="fs-1 text-warning opacity-25"><i class="fas fa-user-tie"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- General Settings Section -->
                <div id="general" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <h5 class="card-title mb-4 border-bottom pb-2">হোম পেজ ও সাধারণ সেটিংস</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">সাইট নাম (Site Name)</label>
                                <input type="text" class="form-control" id="siteName">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">সাইট লোগো URL</label>
                                <input type="text" class="form-control" id="siteLogoUrl">
                            </div>
                            
                            <h6 class="mt-4 text-muted">স্লাইডার ব্যানার</h6>
                            <div class="col-md-4">
                                <label class="form-label">ব্যানার ১ URL</label>
                                <input type="text" class="form-control" id="banner1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ব্যানার ২ URL</label>
                                <input type="text" class="form-control" id="banner2">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ব্যানার ৩ URL</label>
                                <input type="text" class="form-control" id="banner3">
                            </div>

                            <h6 class="mt-4 text-muted">ব্রেকিং নিউজ টিকার</h6>
                            <div class="col-12">
                                <label class="form-label">সংবাদসমূহ (কমা ',' দিয়ে আলাদা করুন)</label>
                                <textarea class="form-control" id="newsTickerInput" rows="3" placeholder="রক্তদাতারা যোগ দিচ্ছেন..., জরুরি রক্তের প্রয়োজন..."></textarea>
                            </div>

                            <button id="btnSaveGeneral" class="btn btn-primary mt-3 w-auto ms-auto">সেভ করুন</button>
                        </div>
                    </div>
                </div>

                <!-- User List Section -->
                <div id="userlist" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <h5 class="mb-0">রেজিস্টার্ড ইউজার (Firestore)</h5>
                            <button id="btnRefreshUsers" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i> রিফ্রেশ</button>
                        </div>
                        
                        <!-- Search Filter -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text bg-body-tertiary"><i class="fas fa-search"></i></span>
                                <input type="text" id="userSearchInput" class="form-control" placeholder="ইমেইল অথবা মোবাইল নম্বর দিয়ে খুঁজুন...">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ইমেইল / নাম</th>
                                        <th>ফোন</th>
                                        <th>UID</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Data will be loaded here from Firebase -->
                                </tbody>
                            </table>
                            <div id="noUsersMsg" class="text-center text-muted py-3 d-none">কোন ইউজার পাওয়া যায়নি</div>
                        </div>
                    </div>
                </div>

                <!-- Contact List Section (New) -->
                <div id="contactlist" class="page-section fade-in d-none">
                    <div class="card p-0 overflow-hidden" style="height: 600px;">
                        <div class="card-header bg-body-tertiary d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <button id="clBackBtn" class="btn btn-sm btn-outline-secondary me-2 d-none" onclick="prevContactStep()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h5 class="m-0" id="clTitle">ক্যাটাগরি নির্বাচন করুন</h5>
                            </div>
                        </div>
                        
                        <div class="cl-slider-container" id="clSlider">
                            <!-- Step 1: Categories -->
                            <div class="cl-slide" id="clStep1">
                                <h6 class="text-muted mb-3">সেবা ক্যাটাগরি</h6>
                                <div class="list-group list-group-flush" id="clCategoryList"></div>
                            </div>

                            <!-- Step 2: Divisions -->
                            <div class="cl-slide" id="clStep2">
                                <h6 class="text-muted mb-3">বিভাগ নির্বাচন করুন</h6>
                                <div class="list-group list-group-flush" id="clDivisionList"></div>
                            </div>

                            <!-- Step 3: Districts -->
                            <div class="cl-slide" id="clStep3">
                                <h6 class="text-muted mb-3">জেলা নির্বাচন করুন</h6>
                                <div class="list-group list-group-flush" id="clDistrictList"></div>
                            </div>

                            <!-- Step 4: Upazilas -->
                            <div class="cl-slide" id="clStep4">
                                <h6 class="text-muted mb-3">উপজেলা নির্বাচন করুন</h6>
                                <div class="list-group list-group-flush" id="clUpazilaList"></div>
                            </div>

                            <!-- Step 5: Result / Add Contact -->
                            <div class="cl-slide" id="clStep5">
                                <div class="alert alert-info py-2 small">
                                    <i class="fas fa-map-marker-alt me-1"></i> <span id="clSelectedBreadcrumb" class="fw-bold"></span>
                                </div>
                                
                                <div id="clLoading" class="text-center py-4 d-none">
                                    <div class="spinner-border text-primary spinner-border-sm"></div> লোড হচ্ছে...
                                </div>

                                <div class="list-group" id="finalContactList" style="padding-bottom: 120px;"></div>

                                <button class="fab-btn" onclick="openContactModal()" title="নতুন কন্টাক্ট যুক্ত করুন">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Contact Modal -->
                <div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="contactModalTitle">নতুন কন্টাক্ট যুক্ত করুন</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="contactForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-6"><label class="small text-muted">সেকশন</label><input type="text" id="modalCategory" class="form-control form-control-sm" disabled></div>
                                        <div class="col-6"><label class="small text-muted">বিভাগ</label><input type="text" id="modalDivision" class="form-control form-control-sm" disabled></div>
                                        <div class="col-6"><label class="small text-muted">জেলা</label><input type="text" id="modalDistrict" class="form-control form-control-sm" disabled></div>
                                        <div class="col-6"><label class="small text-muted">উপজেলা</label><input type="text" id="modalUpazila" class="form-control form-control-sm" disabled></div>
                                    </div>
                                    <hr>
                                    <div class="mb-3"><label class="form-label">নাম (অপশনাল)</label><input type="text" class="form-control" id="modalPersonName" placeholder="ব্যক্তির নাম..."></div>
                                    <div class="mb-3"><label class="form-label">পদ / প্রতিষ্ঠান নাম</label><input type="text" class="form-control" id="modalOfficeName" placeholder="প্রতিষ্ঠানের নাম..." required></div>
                                    <div class="mb-3"><label class="form-label">মোবাইল নম্বর</label><input type="text" class="form-control" id="modalPhone" required></div>
                                    <div class="mb-3"><label class="form-label">ই-মেল (অপশনাল)</label><input type="email" class="form-control" id="modalEmail" placeholder="example@mail.com"></div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                                <button type="button" class="btn btn-primary" id="btnSaveContactDB">সেভ করুন</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Updates Section -->
                <div id="updates" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <h5 class="mb-4">নিউজ ম্যানেজমেন্ট</h5>
                        <div class="card bg-body-tertiary p-3 mb-4">
                            <h6 class="mb-3 text-muted" id="newsFormTitle">নতুন নিউজ পাবলিশ করুন</h6>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">শিরোনাম</label><input type="text" class="form-control" id="newsTitle"></div>
                                <div class="col-md-6"><label class="form-label">তারিখ</label><input type="date" class="form-control" id="newsDate"></div>
                                <div class="col-12"><label class="form-label">ছবির URL</label><input type="text" class="form-control" id="newsImg"></div>
                                <div class="col-12"><label class="form-label">বিস্তারিত</label><textarea class="form-control" id="newsDesc" rows="3"></textarea></div>
                                <div class="col-12 text-end">
                                    <button id="btnCancelEditNews" class="btn btn-secondary d-none me-2">বাতিল</button>
                                    <button id="btnPublishNews" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>পাবলিশ করুন</button>
                                </div>
                            </div>
                        </div>
                        <h6 class="mb-3">প্রকাশিত নিউজ তালিকা</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light"><tr><th style="width: 15%;">তারিখ</th><th style="width: 25%;">শিরোনাম</th><th style="width: 40%;">বিস্তারিত</th><th style="width: 20%;">অ্যাকশন</th></tr></thead>
                                <tbody id="newsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- New Admin Section -->
                <div id="newadmin" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <h5 class="card-title mb-4 border-bottom pb-2">নতুন এডমিন আবেদন তালিকা</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>নাম</th>
                                        <th>মোবাইল</th>
                                        <th>পছন্দের জেলা</th>
                                        <th>আবেদনের তারিখ</th>
                                        <th>স্ট্যাটাস</th>
                                        <th class="text-end">অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="adminApplicationsTableBody">
                                    <!-- Data will be loaded here from Firebase -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="page-section fade-in d-none">
                    <div class="card p-4" style="max-width: 500px; margin: 0 auto;">
                        <h5 class="mb-4 text-primary"><i class="fas fa-user-shield me-2"></i>পাসওয়ার্ড পরিবর্তন</h5>
                        <div class="alert alert-info small">বর্তমানে লগইন করা: <span id="currentEmailDisplay"></span></div>
                        <div class="mb-3">
                            <label class="form-label">নতুন পাসওয়ার্ড</label>
                            <input type="password" class="form-control" id="newFirebasePass">
                            <small class="form-text text-muted">নিরাপত্তার জন্য আপনার বর্তমান বা নতুন পাসওয়ার্ড এখানে দেখানো হবে না।</small>
                        </div>
                        <button id="btnUpdatePass" class="btn btn-warning w-100 fw-bold">পাসওয়ার্ড আপডেট করুন</button>
                    </div>
                    <div class="card p-4 mt-4" style="max-width: 500px; margin: 0 auto;">
                        <h5 class="mb-4 text-success"><i class="fas fa-key me-2"></i>সার্চ পেজ পাস-কী</h5>
                        <div class="mb-3">
                            <label class="form-label">নতুন পাস-কী (৬ ডিজিট)</label>
                            <input type="text" class="form-control" id="newPassKey" placeholder="123456" maxlength="6">
                            <small class="form-text text-muted">বর্তমান কী: <span id="currentPassKeyDisplay" class="fw-bold">লোড হচ্ছে...</span></small>
                        </div>
                        <button id="btnUpdatePassKey" class="btn btn-success w-100 fw-bold">পাস-কী আপডেট করুন</button>
                    </div>
                </div>

                <!-- About Us Section -->
                <div id="about" class="page-section fade-in d-none">
                    <div class="row">
                        <div class="col-lg-7">
                            <div class="card p-4 h-100">
                                <h5 class="mb-3" id="teamFormTitle">টিম মেম্বার যুক্ত করুন</h5>
                                <div class="card bg-body-tertiary p-2 mb-3">
                                    <div class="row g-2 mb-2">
                                        <div class="col-6"><input type="text" class="form-control form-control-sm" id="teamName" placeholder="নাম"></div>
                                        <div class="col-6"><input type="text" class="form-control form-control-sm" id="teamRole" placeholder="পদবী"></div>
                                        <div class="col-12"><input type="text" class="form-control form-control-sm" id="teamContact" placeholder="যোগাযোগ লিঙ্ক (Facebook/Phone)"></div>
                                        <div class="col-12"><input type="text" class="form-control form-control-sm" id="teamImg" placeholder="ছবির URL"></div>
                                        <div class="col-12"><textarea class="form-control form-control-sm" id="teamBio" placeholder="সংক্ষিপ্ত বর্ণনা" rows="2"></textarea></div>
                                        <div class="col-12 text-end">
                                            <button id="btnCancelEditTeam" class="btn btn-sm btn-secondary d-none me-1">বাতিল</button>
                                            <button id="btnAddTeam" class="btn btn-sm btn-success">যুক্ত করুন</button>
                                        </div>
                                    </div>
                                </div>
                                <hr><h6 class="text-muted">টিম লিস্ট</h6>
                                <ul class="list-group list-group-flush" id="teamList"></ul>
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <div class="card p-4 mb-4">
                                <h5 class="mb-3" id="partnerFormTitle">পার্টনার লোগো</h5>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm mb-2" id="partnerLogoUrl" placeholder="লোগো URL">
                                    <input type="text" class="form-control form-control-sm" id="partnerLinkUrl" placeholder="লিঙ্ক URL (website/page)">
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-secondary d-none" type="button" id="btnCancelEditPartner">বাতিল</button>
                                    <button class="btn btn-sm btn-success" type="button" id="btnAddPartner">যুক্ত করুন</button>
                                </div>
                                <hr><h6 class="text-muted">পার্টনার লিস্ট</h6>
                                <div class="d-flex flex-wrap gap-2" id="partnerList"></div>
                            </div>
                            <div class="card p-4">
                                <h5 class="mb-3">পেজ সেটিংস</h5>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="showAdminApplicationToggle">
                                    <label class="form-check-label" for="showAdminApplicationToggle">"Apply to be an admin" বাটন দেখান</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Section -->
                <div id="contact" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <h5 class="mb-4">যোগাযোগের তথ্য আপডেট করুন</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label">মোবাইল নম্বর</label><input type="text" class="form-control" id="contactPhone"></div>
                            <div class="col-md-6"><label class="form-label">ইমেইল</label><input type="text" class="form-control" id="contactEmail"></div>
                            <div class="col-12"><label class="form-label">ঠিকানা</label><input type="text" class="form-control" id="contactAddress"></div>
                            <div class="col-12 text-end"><button id="btnSaveContact" class="btn btn-primary">সেভ করুন</button></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div class="modal fade" id="applicationDetailsModal" tabindex="-1" aria-labelledby="applicationDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="applicationDetailsModalLabel">আবেদনের বিস্তারিত</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="applicationDetailsBody">
                    <!-- Details will be injected here by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বন্ধ করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnKQr2k2ZWnPlEZiJtMDewv6z3Z7p3kiU",
            authDomain: "pacheacchi.firebaseapp.com",
            projectId: "pacheacchi",
            storageBucket: "pacheacchi.firebasestorage.app",
            messagingSenderId: "679996219070",
            appId: "1:679996219070:web:871b64fb4a5be296eac8ef",
            measurementId: "G-M34YKMYHQ8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginSection = document.getElementById('loginSection');
        const mainApp = document.getElementById('mainApp');
        const loadingSpinner = document.getElementById('loadingSpinner');

        let editingNewsId = null, editingTeamId = null, editingPartnerId = null, editingContactDBId = null;
        let contactModal = null, applicationModal = null;
        let currentCLState = { category: '', division: '', district: '', upazila: '' };

        onAuthStateChanged(auth, (user) => user ? showApp(user) : showLogin());

        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const errorMsg = document.getElementById('loginError');
            if (!email || !pass) { errorMsg.innerText = "দয়া করে ইমেইল এবং পাসওয়ার্ড দিন"; return; }
            loadingSpinner.style.display = 'block';
            errorMsg.innerText = '';
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (error) { console.error(error); errorMsg.innerText = "ভুল তথ্য! অথবা পারমিশন নেই।"; } 
            finally { loadingSpinner.style.display = 'none'; }
        });

        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth).then(() => alert("লগ আউট সফল হয়েছে!")).catch(console.error));

        function showLogin() {
            loginSection.classList.remove('d-none');
            mainApp.classList.add('d-none');
            mainApp.classList.remove('d-flex-wrapper');
        }

        function showApp(user) {
            loginSection.classList.add('d-none');
            mainApp.classList.remove('d-none');
            mainApp.classList.add('d-flex-wrapper');
            document.getElementById('displayUsername').innerText = user.email.split('@')[0];
            document.getElementById('currentEmailDisplay').innerText = user.email;
            loadDashboardData();
            loadGeneralSettings();
            contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
            applicationModal = new bootstrap.Modal(document.getElementById('applicationDetailsModal'));
        }

        async function loadDashboardData() {
            try {
                const usersSnap = await getDocs(collection(db, "users"));
                document.getElementById('totalUsersCount').innerText = usersSnap.size;
                const newsSnap = await getDocs(collection(db, "news"));
                document.getElementById('totalNewsCount').innerText = newsSnap.size;
                const teamSnap = await getDocs(collection(db, "team_members"));
                document.getElementById('totalTeamCount').innerText = teamSnap.size;
            } catch (e) { console.log("Data load error: ", e); }
        }

        async function loadGeneralSettings() {
            try {
                const docRef = doc(db, "settings", "siteConfig");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('siteName').value = data.siteName || '';
                    document.getElementById('siteLogoUrl').value = data.logoUrl || '';
                    if (data.banners && Array.isArray(data.banners)) {
                        document.getElementById('banner1').value = data.banners[0] || '';
                        document.getElementById('banner2').value = data.banners[1] || '';
                        document.getElementById('banner3').value = data.banners[2] || '';
                    }
                    if (data.newsTicker && Array.isArray(data.newsTicker)) {
                        document.getElementById('newsTickerInput').value = data.newsTicker.join(', ');
                    }
                }
            } catch (e) { console.error(e); }
        }

        document.getElementById('btnSaveGeneral').addEventListener('click', async () => {
            const data = {
                siteName: document.getElementById('siteName').value,
                logoUrl: document.getElementById('siteLogoUrl').value,
                banners: [document.getElementById('banner1').value, document.getElementById('banner2').value, document.getElementById('banner3').value],
                newsTicker: document.getElementById('newsTickerInput').value.split(',').map(item => item.trim()).filter(item => item),
                updatedAt: new Date()
            };
            try {
                await setDoc(doc(db, "settings", "siteConfig"), data, { merge: true });
                alert("সেটিংস সেভ হয়েছে!");
            } catch (e) { alert("এরর: " + e.message); }
        });

        async function loadNewsList() {
            const tbody = document.getElementById('newsTableBody');
            tbody.innerHTML = '';
            try {
                const snap = await getDocs(collection(db, "news"));
                if (snap.empty) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">কোন নিউজ পাওয়া যায়নি</td></tr>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const tr = document.createElement('tr');
                    const dataStr = encodeURIComponent(JSON.stringify(d));
                    tr.innerHTML = `<td>${d.date || '-'}</td><td>${d.title}</td><td><small>${d.content ? d.content.substring(0, 50) + '...' : ''}</small></td><td><span class="badge bg-warning text-dark action-btn" onclick="editNews('${doc.id}', '${dataStr}')"><i class="fas fa-edit"></i></span><span class="badge bg-danger action-btn" onclick="deleteDocById('news', '${doc.id}')"><i class="fas fa-trash"></i></span></td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('btnPublishNews').addEventListener('click', async () => {
            const data = { title: document.getElementById('newsTitle').value, date: document.getElementById('newsDate').value, imageUrl: document.getElementById('newsImg').value, content: document.getElementById('newsDesc').value };
            if (!data.title) return alert("শিরোনাম দিন!");
            try {
                if (editingNewsId) {
                    await updateDoc(doc(db, "news", editingNewsId), { ...data, updatedAt: new Date() });
                    alert("নিউজ আপডেট হয়েছে!");
                    resetNewsForm();
                } else {
                    await addDoc(collection(db, "news"), { ...data, createdAt: new Date() });
                    alert("নিউজ পাবলিশ হয়েছে!");
                    document.getElementById('newsTitle').value = ""; document.getElementById('newsDate').value = ""; document.getElementById('newsImg').value = ""; document.getElementById('newsDesc').value = "";
                }
                loadNewsList();
            } catch (e) { alert("এরর: " + e.message); }
        });

        window.editNews = (id, dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingNewsId = id;
            document.getElementById('newsTitle').value = data.title || '';
            document.getElementById('newsDate').value = data.date || '';
            document.getElementById('newsImg').value = data.imageUrl || '';
            document.getElementById('newsDesc').value = data.content || '';
            document.getElementById('newsFormTitle').innerText = "নিউজ আপডেট করুন";
            document.getElementById('btnPublishNews').innerText = "আপডেট করুন";
            document.getElementById('btnPublishNews').classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btnCancelEditNews').classList.remove('d-none');
            window.scrollTo(0, 0);
        };

        document.getElementById('btnCancelEditNews').addEventListener('click', resetNewsForm);

        function resetNewsForm() {
            editingNewsId = null;
            document.getElementById('newsTitle').value = ""; document.getElementById('newsDate').value = ""; document.getElementById('newsImg').value = ""; document.getElementById('newsDesc').value = "";
            document.getElementById('newsFormTitle').innerText = "নতুন নিউজ পাবলিশ করুন";
            document.getElementById('btnPublishNews').innerHTML = '<i class="fas fa-paper-plane me-2"></i>পাবলিশ করুন';
            document.getElementById('btnPublishNews').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btnCancelEditNews').classList.add('d-none');
        }

        async function loadUserList() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                if (querySnapshot.empty) { document.getElementById('noUsersMsg').classList.remove('d-none'); return; }
                document.getElementById('noUsersMsg').classList.add('d-none');
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    tbody.innerHTML += `<tr><td>${data.email || data.name || 'Unknown'}</td><td>${data.mobile || data.phone || 'N/A'}</td><td><span class="badge bg-secondary">${doc.id.substring(0,8)}...</span></td></tr>`;
                });
            } catch (e) { tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">ডাটা লোড করা যায়নি (Firestore Rules চেক করুন)</td></tr>`; }
        }
        
        document.getElementById('userSearchInput').addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            document.querySelectorAll('#usersTableBody tr').forEach(row => row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none');
        });

        document.getElementById('btnRefreshUsers').addEventListener('click', loadUserList);
        window.loadUserListRef = loadUserList;

        document.getElementById('btnUpdatePass').addEventListener('click', () => {
            const user = auth.currentUser, newPassword = document.getElementById('newFirebasePass').value;
            if (user && newPassword) { updatePassword(user, newPassword).then(() => { alert("পাসওয়ার্ড পরিবর্তন সফল হয়েছে!"); document.getElementById('newFirebasePass').value = ''; }).catch((error) => alert("এরর: " + error.message)); } 
            else { alert("নতুন পাসওয়ার্ড লিখুন।"); }
        });

        async function loadTeamMembers() {
            const teamList = document.getElementById('teamList');
            teamList.innerHTML = '';
            const snap = await getDocs(collection(db, "team_members"));
            snap.forEach(doc => {
                const d = doc.data();
                const dataStr = encodeURIComponent(JSON.stringify(d));
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<div class="d-flex align-items-center"><img src="${d.image || 'https://via.placeholder.com/40'}" class="list-item-img me-3"><div><strong>${d.name}</strong><br><small class="text-muted">${d.role}</small></div></div><div><button class="btn btn-sm btn-outline-warning me-1" onclick="editTeam('${doc.id}', '${dataStr}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteDocById('team_members', '${doc.id}')"><i class="fas fa-trash"></i></button></div>`;
                teamList.appendChild(li);
            });
        }

        document.getElementById('btnAddTeam').addEventListener('click', async () => {
            const data = { name: document.getElementById('teamName').value, role: document.getElementById('teamRole').value, image: document.getElementById('teamImg').value, bio: document.getElementById('teamBio').value, contact: document.getElementById('teamContact').value };
            if (!data.name) return alert("নাম দিন");
            try {
                if (editingTeamId) {
                    await updateDoc(doc(db, "team_members", editingTeamId), data);
                    alert("আপডেট হয়েছে!");
                    resetTeamForm();
                } else {
                    await addDoc(collection(db, "team_members"), data);
                    alert("যুক্ত হয়েছে!");
                    document.getElementById('teamName').value = ''; document.getElementById('teamRole').value = ''; document.getElementById('teamImg').value = ''; document.getElementById('teamBio').value = ''; document.getElementById('teamContact').value = '';
                }
                loadTeamMembers();
            } catch (e) { alert(e.message); }
        });

        window.editTeam = (id, dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingTeamId = id;
            document.getElementById('teamName').value = data.name || ''; document.getElementById('teamRole').value = data.role || ''; document.getElementById('teamImg').value = data.image || ''; document.getElementById('teamBio').value = data.bio || ''; document.getElementById('teamContact').value = data.contact || '';
            document.getElementById('teamFormTitle').innerText = "মেম্বার আপডেট করুন";
            document.getElementById('btnAddTeam').innerText = "আপডেট";
            document.getElementById('btnAddTeam').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btnCancelEditTeam').classList.remove('d-none');
        };

        document.getElementById('btnCancelEditTeam').addEventListener('click', resetTeamForm);

        function resetTeamForm() {
            editingTeamId = null;
            document.getElementById('teamName').value = ''; document.getElementById('teamRole').value = ''; document.getElementById('teamImg').value = ''; document.getElementById('teamBio').value = ''; document.getElementById('teamContact').value = '';
            document.getElementById('teamFormTitle').innerText = "টিম মেম্বার যুক্ত করুন";
            document.getElementById('btnAddTeam').innerText = "যুক্ত করুন";
            document.getElementById('btnAddTeam').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btnCancelEditTeam').classList.add('d-none');
        }

        async function loadPartners() {
            const partnerList = document.getElementById('partnerList');
            partnerList.innerHTML = '';
            const snap = await getDocs(collection(db, "partners"));
            snap.forEach(doc => {
                const d = doc.data();
                const dataStr = encodeURIComponent(JSON.stringify(d));
                const div = document.createElement('div');
                div.className = 'position-relative d-inline-block border p-1 rounded';
                div.innerHTML = `<img src="${d.imageUrl}" style="height: 40px; cursor:pointer;" onclick="editPartner('${doc.id}', '${dataStr}')" title="এডিট করতে ক্লিক করুন"><button class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border-0" onclick="deleteDocById('partners', '${doc.id}')">x</button>`;
                partnerList.appendChild(div);
            });
        }

        document.getElementById('btnAddPartner').addEventListener('click', async () => {
            const data = { imageUrl: document.getElementById('partnerLogoUrl').value, linkUrl: document.getElementById('partnerLinkUrl').value };
            if (!data.imageUrl) return alert("লোগো URL দিন");
            try {
                if (editingPartnerId) { await updateDoc(doc(db, "partners", editingPartnerId), data); alert("আপডেট হয়েছে!"); resetPartnerForm(); } 
                else { await addDoc(collection(db, "partners"), data); alert("যুক্ত হয়েছে!"); document.getElementById('partnerLogoUrl').value = ''; document.getElementById('partnerLinkUrl').value = ''; }
                loadPartners();
            } catch (e) { alert(e.message); }
        });

        window.editPartner = (id, dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingPartnerId = id;
            document.getElementById('partnerLogoUrl').value = data.imageUrl || ''; document.getElementById('partnerLinkUrl').value = data.linkUrl || '';
            document.getElementById('partnerFormTitle').innerText = "লোগো আপডেট করুন";
            document.getElementById('btnAddPartner').innerText = "আপডেট";
            document.getElementById('btnAddPartner').classList.replace('btn-success', 'btn-warning');
            document.getElementById('btnCancelEditPartner').classList.remove('d-none');
        };

        document.getElementById('btnCancelEditPartner').addEventListener('click', resetPartnerForm);

        function resetPartnerForm() {
            editingPartnerId = null;
            document.getElementById('partnerLogoUrl').value = ''; document.getElementById('partnerLinkUrl').value = '';
            document.getElementById('partnerFormTitle').innerText = "পার্টনার লোগো যুক্ত করুন";
            document.getElementById('btnAddPartner').innerText = "যুক্ত করুন";
            document.getElementById('btnAddPartner').classList.replace('btn-warning', 'btn-success');
            document.getElementById('btnCancelEditPartner').classList.add('d-none');
        }

        async function loadContactInfo() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "contact"));
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('contactPhone').value = d.phone || ''; document.getElementById('contactEmail').value = d.email || ''; document.getElementById('contactAddress').value = d.address || '';
                }
            } catch (e) { console.log(e); }
        }

        document.getElementById('btnSaveContact').addEventListener('click', async () => {
            const data = { phone: document.getElementById('contactPhone').value, email: document.getElementById('contactEmail').value, address: document.getElementById('contactAddress').value };
            await setDoc(doc(db, "settings", "contact"), data, { merge: true });
            alert("সেভ হয়েছে!");
        });

        window.loadContactListDB = async (category, division, district, upazila) => {
            const listContainer = document.getElementById('finalContactList'), loader = document.getElementById('clLoading');
            listContainer.innerHTML = ''; loader.classList.remove('d-none');
            currentCLState = { category, division, district, upazila };
            try {
                const q = query(collection(db, "contacts"), where("category", "==", category), where("division", "==", division), where("district", "==", district), where("upazila", "==", upazila));
                const querySnapshot = await getDocs(q);
                loader.classList.add('d-none');
                if (querySnapshot.empty) { listContainer.innerHTML = '<div class="text-center text-muted py-4">এই লোকেশনে কোন ডাটা পাওয়া যায়নি।</div>'; return; }
                querySnapshot.forEach((doc) => {
                    const d = doc.data(), dataStr = encodeURIComponent(JSON.stringify(d));
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center mb-2 shadow-sm border rounded';
                    const cleanDetails = d.details ? d.details.replace(' | ', ', ') : '';
                    item.innerHTML = `<div><h6 class="mb-1 fw-bold">${d.name}</h6><div class="small text-muted"><i class="fas fa-phone-alt me-1"></i> ${d.phone}</div>${cleanDetails ? `<div class="small text-muted"><i class="fas fa-info-circle me-1"></i> ${cleanDetails}</div>` : ''}</div><div class="d-flex gap-2"><button class="btn btn-sm btn-outline-warning" onclick="editContactDB('${doc.id}', '${dataStr}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteContactDB('${doc.id}')"><i class="fas fa-trash"></i></button></div>`;
                    listContainer.appendChild(item);
                });
            } catch (e) { loader.classList.add('d-none'); listContainer.innerHTML = `<div class="alert alert-danger">ডাটা লোড করতে সমস্যা: ${e.message}</div>`; console.error(e); }
        };

        document.getElementById('btnSaveContactDB').addEventListener('click', async () => {
            const dataPayload = { name: document.getElementById('modalOfficeName').value, phone: document.getElementById('modalPhone').value, details: [document.getElementById('modalPersonName').value, document.getElementById('modalEmail').value].filter(Boolean).join(" | "), category: currentCLState.category, division: currentCLState.division, district: currentCLState.district, upazila: currentCLState.upazila, updatedAt: new Date() };
            if (!dataPayload.name || !dataPayload.phone) return alert("প্রতিষ্ঠান নাম এবং ফোন নম্বর আবশ্যক");
            try {
                if (editingContactDBId) { await updateDoc(doc(db, "contacts", editingContactDBId), dataPayload); alert("আপডেট সফল হয়েছে!"); } 
                else { dataPayload.createdAt = new Date(); dataPayload.source = "admin_panel"; await addDoc(collection(db, "contacts"), dataPayload); alert("যুক্ত সফল হয়েছে!"); }
                contactModal.hide();
                resetContactModal();
                window.loadContactListDB(currentCLState.category, currentCLState.division, currentCLState.district, currentCLState.upazila);
            } catch (e) { alert("এরর: " + e.message); }
        });

        window.editContactDB = (id, dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingContactDBId = id;
            document.getElementById('modalCategory').value = data.category || ''; document.getElementById('modalDivision').value = data.division || ''; document.getElementById('modalDistrict').value = data.district || ''; document.getElementById('modalUpazila').value = data.upazila || '';
            document.getElementById('modalOfficeName').value = data.name || ''; document.getElementById('modalPhone').value = data.phone || '';
            let pName = "", email = "";
            if (data.details) { const parts = data.details.split(" | "); if (parts.length > 0) pName = parts[0]; if (parts.length > 1) email = parts[1]; if (pName.includes('@') && !email) { email = pName; pName = ""; } }
            document.getElementById('modalPersonName').value = pName; document.getElementById('modalEmail').value = email;
            document.getElementById('contactModalTitle').innerText = "কন্টাক্ট এডিট করুন";
            document.getElementById('btnSaveContactDB').innerText = "আপডেট";
            contactModal.show();
        };

        window.deleteContactDB = async (id) => {
            if (confirm("আপনি কি নিশ্চিত এই কন্টাক্টটি মুছে ফেলতে চান?")) {
                try {
                    await deleteDoc(doc(db, "contacts", id));
                    window.loadContactListDB(currentCLState.category, currentCLState.division, currentCLState.district, currentCLState.upazila);
                } catch (e) { alert("এরর: " + e.message); }
            }
        };

        window.openContactModal = () => {
            resetContactModal();
            document.getElementById('modalCategory').value = currentCLState.category; document.getElementById('modalDivision').value = currentCLState.division; document.getElementById('modalDistrict').value = currentCLState.district; document.getElementById('modalUpazila').value = currentCLState.upazila;
            contactModal.show();
        };

        function resetContactModal() {
            editingContactDBId = null;
            document.getElementById('contactForm').reset();
            document.getElementById('contactModalTitle').innerText = "নতুন কন্টাক্ট যুক্ত করুন";
            document.getElementById('btnSaveContactDB').innerText = "সেভ করুন";
        }

        document.getElementById('btnUpdatePassKey').addEventListener('click', async () => {
            const pk = document.getElementById('newPassKey').value;
            if (pk.length < 4) return alert("মিনিমাম ৪ ডিজিট দিন");
            try {
                await setDoc(doc(db, "settings", "admin"), { passKey: pk }, { merge: true });
                alert("পাস-কী সফলভাবে আপডেট হয়েছে!");
                document.getElementById('currentPassKeyDisplay').innerText = pk; document.getElementById('newPassKey').value = '';
            } catch (e) { alert("এরর: " + e.message); }
        });
        
        async function loadSettingsData() {
            try {
                const docSnap = await getDoc(doc(db, "settings", "admin"));
                document.getElementById('currentPassKeyDisplay').innerText = (docSnap.exists() && docSnap.data().passKey) ? docSnap.data().passKey : 'এখনো সেট করা হয়নি';
            } catch (e) { document.getElementById('currentPassKeyDisplay').innerText = 'লোড করা যায়নি'; console.error("Error fetching passkey:", e); }
        }

        const adminAppToggle = document.getElementById('showAdminApplicationToggle');
        async function loadAboutPageSettings() {
            try {
                const docRef = doc(db, "settings", "siteConfig");
                const docSnap = await getDoc(docRef);
                adminAppToggle.checked = docSnap.exists() && docSnap.data().showAdminApplicationButton === true;
            } catch (e) { console.error("Error loading About Page settings:", e); adminAppToggle.checked = false; }
        }
        adminAppToggle.addEventListener('change', async (event) => {
            try {
                await setDoc(doc(db, "settings", "siteConfig"), { showAdminApplicationButton: event.target.checked }, { merge: true });
                alert("সেটিংস সেভ হয়েছে!");
            } catch (e) { alert("এরর: " + e.message); }
        });

        // --- NEW ADMIN APPLICATION LOGIC ---
        async function loadAdminApplications() {
            const tbody = document.getElementById('adminApplicationsTableBody');
            tbody.innerHTML = ''; 
            try {
                const q = query(collection(db, "adminApplications"), orderBy("appliedAt", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">কোনো নতুন আবেদন পাওয়া যায়নি।</td></tr>`;
                    return;
                }
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const appliedDate = data.appliedAt.toDate().toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
                    const dataStr = encodeURIComponent(JSON.stringify(data));

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data.name}</td>
                        <td>${data.mobile}</td>
                        <td>${data.preferredDistrict}</td>
                        <td>${appliedDate}</td>
                        <td><span class="badge bg-warning text-dark">${data.status || 'pending'}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="showApplicationDetails('${dataStr}')"><i class="fas fa-eye me-1"></i> বিস্তারিত</button>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteDocById('adminApplications', '${id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Error loading admin applications:", error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">আবেদন লোড করতে সমস্যা হয়েছে।</td></tr>`;
            }
        }
        window.loadAdminApplications = loadAdminApplications;

        window.showApplicationDetails = (encodedData) => {
            const data = JSON.parse(decodeURIComponent(encodedData));
            const detailsBody = document.getElementById('applicationDetailsBody');
            const fullAddress = `${data.address.village}, ${data.address.postOffice} - ${data.address.postalCode}, ${data.address.upazila}, ${data.address.district}, ${data.address.division}`;
            
            detailsBody.innerHTML = `
                <p><strong>নাম:</strong> ${data.name}</p>
                <p><strong>বয়স:</strong> ${data.age}</p>
                <p><strong>মোবাইল:</strong> ${data.mobile}</p>
                <p><strong>ইমেইল:</strong> ${data.email}</p>
                <hr>
                <p><strong>সম্পূর্ণ ঠিকানা:</strong> ${fullAddress}</p>
                <hr>
                <p><strong>পছন্দের জেলা:</strong> ${data.preferredDistrict}</p>
                <p><strong>স্ট্যাটাস:</strong> <span class="badge bg-warning text-dark">${data.status}</span></p>
            `;
            applicationModal.show();
        };

        window.deleteDocById = async (collectionName, docId) => {
            if (confirm("আপনি কি নিশ্চিতভাবে এটি মুছে ফেলতে চান?")) {
                await deleteDoc(doc(db, collectionName, docId));
                if (collectionName === 'team_members') loadTeamMembers();
                if (collectionName === 'partners') loadPartners();
                if (collectionName === 'news') loadNewsList();
                if (collectionName === 'adminApplications') loadAdminApplications();
            }
        };

        window.loadAboutData = () => { loadTeamMembers(); loadPartners(); loadAboutPageSettings(); };
        window.loadContactData = loadContactInfo;
        window.loadNewsData = loadNewsList;
        window.loadSettingsData = loadSettingsData;

    </script>

    <!-- UI Logic Script (No Firebase) -->
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('show', sidebar.classList.contains('active'));
        }

        function showPage(pageId, element) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
            const target = document.getElementById(pageId);
            if (target) {
                target.classList.remove('d-none');
                target.classList.remove('fade-in');
                void target.offsetWidth;
                target.classList.add('fade-in');
            }

            if (element) {
                document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active-link'));
                element.classList.add('active-link');
                if (window.innerWidth < 768) toggleSidebar();
            }

            if (pageId === 'userlist' && window.loadUserListRef) window.loadUserListRef();
            if (pageId === 'about' && window.loadAboutData) window.loadAboutData();
            if (pageId === 'contact' && window.loadContactData) window.loadContactData();
            if (pageId === 'updates' && window.loadNewsData) window.loadNewsData();
            if (pageId === 'settings' && window.loadSettingsData) window.loadSettingsData();
            if (pageId === 'contactlist') initContactList();
            if (pageId === 'newadmin' && window.loadAdminApplications) window.loadAdminApplications();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('themeBtn');
            const icon = btn.querySelector('i');
            const isDark = html.getAttribute('data-bs-theme') === 'dark';
            html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
            icon.classList.toggle('fa-moon', isDark);
            icon.classList.toggle('fa-sun', !isDark);
            btn.classList.toggle('btn-outline-secondary', isDark);
            btn.classList.toggle('btn-outline-warning', !isDark);
        }

        const bdGeoData = {
            "Dhaka": {"Dhaka": ["Savar", "Dhamrai"], "Gazipur": ["Gazipur Sadar"]},
            "Chittagong": {"Chittagong": ["Sitakunda", "Mirsharai"], "Comilla": ["Comilla Sadar"]},
        };
        const clCategories = [
            { id: 'police', name: 'পুলিশ স্টেশন', icon: 'fa-user-shield' },
            { id: 'hospital', name: 'হাসপাতাল', icon: 'fa-hospital' },
        ];
        let clState = { step: 0, category: '', division: '', district: '', upazila: '' };

        function initContactList() {
            renderCategories();
            goToClStep(0);
        }

        function goToClStep(stepIndex) {
            clState.step = stepIndex;
            document.getElementById('clSlider').style.transform = `translateX(-${stepIndex * 20}%)`;
            const titles = ["ক্যাটাগরি", "বিভাগ", "জেলা", "উপজেলা", "রেজাল্ট"];
            document.getElementById('clTitle').innerText = titles[stepIndex] + " নির্বাচন করুন";
            document.getElementById('clBackBtn').classList.toggle('d-none', stepIndex === 0);
        }

        function prevContactStep() {
            if (clState.step > 0) goToClStep(clState.step - 1);
        }

        function renderList(containerId, items, onClick) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'list-group-item cl-item py-3';
                if(typeof item === 'object'){
                    el.innerHTML = `<i class="fas ${item.icon} me-3 text-primary" style="width:20px"></i> ${item.name}`;
                    el.onclick = () => onClick(item.name);
                } else {
                    el.innerText = item;
                    el.onclick = () => onClick(item);
                }
                container.appendChild(el);
            });
        }

        const renderCategories = () => renderList('clCategoryList', clCategories, name => { clState.category = name; renderDivisions(); goToClStep(1); });
        const renderDivisions = () => renderList('clDivisionList', Object.keys(bdGeoData), name => { clState.division = name; renderDistricts(name); goToClStep(2); });
        const renderDistricts = (div) => renderList('clDistrictList', Object.keys(bdGeoData[div]), name => { clState.district = name; renderUpazilas(div, name); goToClStep(3); });
        const renderUpazilas = (div, dist) => renderList('clUpazilaList', bdGeoData[div][dist], name => { clState.upazila = name; showResultPage(); goToClStep(4); });
        
        function showResultPage() {
            document.getElementById('clSelectedBreadcrumb').innerText = `${clState.category} > ${clState.division} > ${clState.district} > ${clState.upazila}`;
            if (window.loadContactListDB) window.loadContactListDB(clState.category, clState.division, clState.district, clState.upazila);
        }
    </script>
</body>
</html>
