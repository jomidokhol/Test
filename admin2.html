<!DOCTYPE html>
<html lang="bn" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secondary Admin Panel</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4e73df;
            --sidebar-width: 260px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Poppins', 'Hind Siliguri', sans-serif;
            background-color: var(--bs-body-bg);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden;
            margin: 0;
        }

        /* --- Login Screen Styling --- */
        .login-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            transition: all 0.5s ease;
        }
        .login-card {
            width: 100%; max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideUp 0.5s ease;
        }

        /* --- Layout Structure --- */
        .d-flex-wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh;
            align-items: stretch;
            position: relative;
        }

        /* --- Sidebar --- */
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: #2c3e50;
            color: #fff;
            height: 100vh;
            transition: all var(--transition-speed);
            z-index: 1050;
            position: fixed;
            top: 0; left: 0;
            overflow-y: auto;
            margin-left: calc(var(--sidebar-width) * -1); /* Hidden initially */
        }
        
        #sidebar.active {
            margin-left: 0; /* Show sidebar */
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            text-align: center;
            font-weight: 600;
            font-size: 1.3rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #sidebar ul.components {
            padding: 20px 0;
            list-style: none;
            margin: 0;
        }

        #sidebar ul li a {
            padding: 15px 25px;
            font-size: 0.95rem;
            display: block;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        
        #sidebar ul li a.disabled-link {
            color: #888;
            pointer-events: none;
            background: rgba(0,0,0,0.1);
        }

        #sidebar ul li a:hover, #sidebar ul li a.active-link {
            color: #fff;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary-color);
            padding-left: 30px;
        }

        /* --- Content Area --- */
        #content {
            width: 100%;
            margin-left: 0;
            transition: all var(--transition-speed);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.5); 
            z-index: 1040;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.show { display: block; }

        /* --- Top Navigation Bar --- */
        .navbar {
            padding: 15px 25px;
            background: var(--bs-body-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--bs-border-color);
        }

        .main-content {
            padding: 30px;
            flex: 1;
        }

        /* --- Cards & Tables --- */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.03);
            transition: transform 0.2s;
            margin-bottom: 24px;
        }
        
        .stat-card { border-left: 5px solid; }

        /* --- Animations --- */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading Spinner */
        #loadingSpinner {
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 3000;
        }

        /* Small item styling for list */
        .list-item-img {
            width: 40px; height: 40px; object-fit: cover; border-radius: 50%;
        }
        
        /* Action buttons in tables */
        .action-btn {
            cursor: pointer;
            margin-left: 5px;
        }

        /* Contact List Slider Styles */
        .cl-slider-container {
            width: 500%; /* 5 steps */
            display: flex;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            height: 100%;
        }
        .cl-slide {
            width: 20%; /* 100% / 5 */
            flex-shrink: 0;
            padding: 10px;
            height: 100%;
            overflow-y: auto;
            position: relative;
        }
        .cl-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--bs-border-color);
        }
        .cl-item:hover {
            background-color: var(--bs-tertiary-bg);
            transform: translateX(5px);
            border-color: var(--primary-color);
        }
        
        /* Floating Action Button */
        .fab-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: transform 0.2s;
        }
        .fab-btn:hover {
            transform: scale(1.1);
            background-color: #375ac7;
        }
    </style>
</head>
<body>

    <!-- Loading Spinner -->
    <div id="loadingSpinner">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 1. Login Screen -->
    <div id="loginSection" class="login-wrapper">
        <div class="card login-card p-5 bg-white text-dark">
            <div class="text-center mb-4">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; font-size: 24px;">
                    <i class="fas fa-fire"></i>
                </div>
                <h3>সেকেন্ডারি এডমিন প্যানেল</h3>
                <p class="text-muted small">এডমিন নিরাপদ লগইন</p>
            </div>
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="adminEmail" placeholder="name@example.com">
                <label for="adminEmail">ইমেইল এড্রেস</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="adminPass" placeholder="password">
                <label for="adminPass">পাসওয়ার্ড</label>
            </div>
            <button id="btnLogin" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">প্রবেশ করুন</button>
            <small class="text-danger text-center mt-3 d-block" id="loginError"></small>
        </div>
    </div>

    <!-- Overlay -->
    <div class="sidebar-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <!-- 2. Main Application Wrapper -->
    <div class="d-flex-wrapper d-none" id="mainApp">
        
        <!-- SIDEBAR MENU (Secondary Panel Version) -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-rocket me-2"></i> সাইট মেনু
            </div>
            <ul class="components">
                <!-- Links as requested by the user -->
                <li><a href="#" onclick="showPage('terms', this)" class="active-link" data-menu-item="true"><i class="fas fa-file-contract me-3"></i>টার্মস এন্ড রেগুলেশন</a></li>
                <li><a href="#" onclick="showPage('userlist', this)" data-menu-item="true"><i class="fas fa-users me-3"></i>ইউজার লিস্ট</a></li>
                <li><a href="#" onclick="showPage('contactlist', this)" data-menu-item="true"><i class="fas fa-address-book me-3"></i>কন্টাক্ট লিস্ট</a></li>
                <li><a href="#" onclick="showPage('updates', this)" data-menu-item="true"><i class="fas fa-bullhorn me-3"></i>নিউজ আপডেট</a></li>
                <li><a href="#" onclick="promptForSettings(this)"><i class="fas fa-cog me-3"></i>সেটিংস</a></li>
            </ul>
            <div class="text-center mt-5">
                <button id="btnLogout" class="btn btn-danger btn-sm w-75 rounded-pill"><i class="fas fa-sign-out-alt me-2"></i>লগ আউট</button>
            </div>
        </nav>

        <!-- CONTENT AREA -->
        <div id="content">
            
            <!-- TOP MENU BAR -->
            <nav class="navbar navbar-expand-lg sticky-top">
                <div class="container-fluid">
                    <!-- Toggle Button (Hamburger) -->
                    <button type="button" id="sidebarCollapse" class="btn btn-primary shadow-sm" onclick="toggleSidebar()">
                        <i class="fas fa-bars me-1"></i> <span class="d-none d-sm-inline">মেনু</span>
                    </button>
                    
                    <div class="d-flex align-items-center ms-auto">
                        <button class="btn btn-outline-secondary border-0 me-3" onclick="toggleTheme()" id="themeBtn" title="Change Theme">
                            <i class="fas fa-moon"></i>
                        </button>
                        
                        <div class="dropdown">
                            <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-body" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="https://ui-avatars.com/api/?name=Admin&background=4e73df&color=fff" alt="" width="40" height="40" class="rounded-circle me-2 border">
                                <span class="fw-bold small d-none d-sm-inline" id="displayUsername">Admin</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item" href="#" onclick="promptForSettings(this)"><i class="fas fa-user me-2"></i>প্রোফাইল</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Dynamic Content -->
            <div class="main-content">
                
                <!-- Terms and Regulations Section (NEW) -->
                <div id="terms" class="page-section fade-in">
                    <div class="card p-4">
                        <h4 class="mb-3">টার্মস এন্ড রেগুলেশন</h4>
                        <p>এই অ্যাডমিন প্যানেলটি ব্যবহার করার জন্য আপনাকে অবশ্যই নিম্নলিখিত নিয়ম ও শর্তাবলী মেনে চলতে হবে। কোনো প্রকার অপব্যবহার বা নিয়মের লঙ্ঘন আপনার অ্যাক্সেস স্থায়ীভাবে বাতিল করার কারণ হতে পারে।</p>
                        <ol>
                            <li><strong>গোপনীয়তা:</strong> এই প্যানেলের মাধ্যমে প্রাপ্ত সকল ব্যবহারকারীর তথ্য (যেমন: ইমেইল, ফোন নম্বর) সম্পূর্ণ গোপনীয়। এই তথ্য কোনো তৃতীয় পক্ষের সাথে শেয়ার করা বা বাণিজ্যিক উদ্দেশ্যে ব্যবহার করা কঠোরভাবে নিষিদ্ধ।</li>
                            <li><strong>জেলার দায়িত্ব:</strong> প্রত্যেক অ্যাডমিনকে একটি নির্দিষ্ট জেলা পরিচালনার দায়িত্ব দেওয়া হয়েছে। আপনাকে শুধুমাত্র আপনার নির্ধারিত জেলার ডেটা ম্যানেজ করার অনুমতি দেওয়া হয়েছে। অন্য জেলার কার্যক্রমে হস্তক্ষেপ করা যাবে না।</li>
                            <li><strong>ডেটা ম্যানেজমেন্ট:</strong> কন্টাক্ট লিস্ট বা নিউজ আপডেটের সময় সঠিক এবং যাচাইকৃত তথ্য প্রদান করা আপনার দায়িত্ব। কোনো প্রকার ভুল, মিথ্যা বা বিভ্রান্তিকর তথ্য প্রবেশ করানো যাবে না।</li>
                            <li><strong>নিরাপত্তা:</strong> আপনার লগইন তথ্য (ইমেইল এবং পাসওয়ার্ড) সুরক্ষিত রাখার দায়িত্ব আপনার। আপনার অ্যাকাউন্ট থেকে কোনো অনাকাঙ্ক্ষিত কার্যকলাপের জন্য আপনি দায়ী থাকবেন।</li>
                            <li><strong>সিস্টেমের ব্যবহার:</strong> এই সিস্টেমটি শুধুমাত্র নির্ধারিত প্রশাসনিক কাজের জন্য ব্যবহার করা যাবে। সিস্টেমের কোনো দুর্বলতা খুঁজে বের করার চেষ্টা করা বা সিস্টেমের ক্ষতি করা শাস্তিযোগ্য অপরাধ হিসেবে গণ্য হবে।</li>
                        </ol>
                        <div class="alert alert-warning mt-3">
                            <strong>বিশেষ দ্রষ্টব্য:</strong> যদি আপনার কাজের জন্য জেলা নির্ধারণ করা না থাকে, তাহলে দয়া করে অবিলম্বে সেটিংস পেজ থেকে আপনার জেলা নির্বাচন করুন। জেলা নির্ধারণ না করা পর্যন্ত আপনি অন্যান্য ফিচার ব্যবহার করতে পারবেন না।
                        </div>
                    </div>
                </div>

                <!-- User List Section -->
                <div id="userlist" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                            <h5 class="mb-0">রেজিস্টার্ড ইউজার (Firestore)</h5>
                            <button id="btnRefreshUsers" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync"></i> রিফ্রেশ</button>
                        </div>
                        
                        <!-- Search Filter -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text bg-body-tertiary"><i class="fas fa-search"></i></span>
                                <input type="text" id="userSearchInput" class="form-control" placeholder="ইমেইল অথবা মোবাইল নম্বর দিয়ে খুঁজুন...">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>ইমেইল / নাম</th>
                                        <th>ফোন</th>
                                        <th>UID</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Data will be loaded here from Firebase -->
                                </tbody>
                            </table>
                            <div id="noUsersMsg" class="text-center text-muted py-3 d-none">কোন ইউজার পাওয়া যায়নি</div>
                        </div>
                    </div>
                </div>

                <!-- Contact List Section -->
                <div id="contactlist" class="page-section fade-in d-none">
                    <div class="card p-0 overflow-hidden" style="height: 600px;">
                        <div class="card-header bg-body-tertiary d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <button id="clBackBtn" class="btn btn-sm btn-outline-secondary me-2 d-none" onclick="prevContactStep()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <h5 class="m-0" id="clTitle">ক্যাটাগরি নির্বাচন করুন</h5>
                            </div>
                        </div>
                        
                        <div class="cl-slider-container" id="clSlider">
                            <!-- Step 1: Categories -->
                            <div class="cl-slide" id="clStep1">
                                <h6 class="text-muted mb-3">সেবা ক্যাটাগরি</h6>
                                <div class="list-group list-group-flush" id="clCategoryList"></div>
                            </div>

                            <!-- Step 2: Divisions -->
                            <div class="cl-slide" id="clStep2">
                                <h6 class="text-muted mb-3">বিভাগ নির্বাচন করুন</h6>
                                <div class="list-group list-group-flush" id="clDivisionList"></div>
                            </div>

                            <!-- Step 3: Districts -->
                            <div class="cl-slide" id="clStep3">
                                <h6 class="text-muted mb-3">জেলা নির্বাচন করুন</h6>
                                <div class="list-group list-group-flush" id="clDistrictList"></div>
                            </div>

                            <!-- Step 4: Upazilas -->
                            <div class="cl-slide" id="clStep4">
                                <h6 class="text-muted mb-3">উপজেলা নির্বাচন করুন</h6>
                                <div class="list-group list-group-flush" id="clUpazilaList"></div>
                            </div>

                            <!-- Step 5: Result / Add Contact -->
                            <div class="cl-slide" id="clStep5">
                                <div class="alert alert-info py-2 small">
                                    <i class="fas fa-map-marker-alt me-1"></i> <span id="clSelectedBreadcrumb" class="fw-bold"></span>
                                </div>
                                
                                <div id="clLoading" class="text-center py-4 d-none">
                                    <div class="spinner-border text-primary spinner-border-sm"></div> লোড হচ্ছে...
                                </div>

                                <div class="list-group" id="finalContactList" style="padding-bottom: 120px;"></div>

                                <!-- Floating Add Button -->
                                <button class="fab-btn" onclick="openContactModal()" title="নতুন কন্টাক্ট যুক্ত করুন">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Contact Modal -->
                <div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="contactModalTitle">নতুন কন্টাক্ট যুক্ত করুন</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="contactForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-6"><label class="small text-muted">সেকশন</label><input type="text" id="modalCategory" class="form-control form-control-sm" disabled></div>
                                        <div class="col-6"><label class="small text-muted">বিভাগ</label><input type="text" id="modalDivision" class="form-control form-control-sm" disabled></div>
                                        <div class="col-6"><label class="small text-muted">জেলা</label><input type="text" id="modalDistrict" class="form-control form-control-sm" disabled></div>
                                        <div class="col-6"><label class="small text-muted">উপজেলা</label><input type="text" id="modalUpazila" class="form-control form-control-sm" disabled></div>
                                    </div>
                                    <hr>
                                    <div class="mb-3"><label class="form-label">নাম (অপশনাল)</label><input type="text" class="form-control" id="modalPersonName" placeholder="ব্যক্তির নাম..."></div>
                                    <div class="mb-3"><label class="form-label">পদ / প্রতিষ্ঠান নাম</label><input type="text" class="form-control" id="modalOfficeName" placeholder="প্রতিষ্ঠানের নাম..." required></div>
                                    <div class="mb-3"><label class="form-label">মোবাইল নম্বর</label><input type="text" class="form-control" id="modalPhone" required></div>
                                    <div class="mb-3"><label class="form-label">ই-মেল (অপশনাল)</label><input type="email" class="form-control" id="modalEmail" placeholder="example@mail.com"></div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বাতিল</button>
                                <button type="button" class="btn btn-primary" id="btnSaveContactDB">সেভ করুন</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Updates Section -->
                <div id="updates" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <h5 class="mb-4">নিউজ ম্যানেজমেন্ট</h5>
                        
                        <!-- Form -->
                        <div class="card bg-body-tertiary p-3 mb-4">
                            <h6 class="mb-3 text-muted" id="newsFormTitle">নতুন নিউজ পাবলিশ করুন</h6>
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label">শিরোনাম</label><input type="text" class="form-control" id="newsTitle"></div>
                                <div class="col-md-6"><label class="form-label">তারিখ</label><input type="date" class="form-control" id="newsDate"></div>
                                <div class="col-12"><label class="form-label">ছবির URL</label><input type="text" class="form-control" id="newsImg"></div>
                                <div class="col-12"><label class="form-label">বিস্তারিত</label><textarea class="form-control" id="newsDesc" rows="3"></textarea></div>
                                <div class="col-12 text-end">
                                    <button id="btnCancelEditNews" class="btn btn-secondary d-none me-2">বাতিল</button>
                                    <button id="btnPublishNews" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>পাবলিশ করুন</button>
                                </div>
                            </div>
                        </div>

                        <!-- List -->
                        <h6 class="mb-3">প্রকাশিত নিউজ তালিকা</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 15%;">তারিখ</th>
                                        <th style="width: 25%;">শিরোনাম</th>
                                        <th style="width: 40%;">বিস্তারিত</th>
                                        <th style="width: 20%;">অ্যাকশন</th>
                                    </tr>
                                </thead>
                                <tbody id="newsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section (MODIFIED) -->
                <div id="settings" class="page-section fade-in d-none">
                    <div class="card p-4">
                        <h5 class="mb-4">এডমিন সেটিংস</h5>
                        <!-- First Time Setup Message -->
                        <div id="firstTimeSetupMsg" class="alert alert-info d-none">
                            <strong>স্বাগতম!</strong> অ্যাডমিন হিসেবে কাজ শুরু করার জন্য, অনুগ্রহ করে নিচের "গ্লোবাল ডেটা ফিল্টার" থেকে আপনার কাজের জন্য একটি জেলা নির্বাচন করে সেভ করুন। জেলা নির্ধারণ না করা পর্যন্ত আপনি অন্য কোনো পেজ ব্যবহার করতে পারবেন না।
                        </div>
                        <!-- Admin Name Settings -->
                        <div class="card bg-body-tertiary p-3 mb-4">
                            <h6 class="text-muted mb-3">এডমিনের নাম পরিবর্তন</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" id="adminNameInput" placeholder="নতুন নাম দিন...">
                                <button class="btn btn-primary" type="button" id="btnSaveAdminName">সেভ করুন</button>
                            </div>
                            <small class="form-text text-muted mt-1">এই নামটি উপরের ডানদিকে প্রদর্শিত হবে।</small>
                        </div>
                        <!-- District Filter Settings -->
                        <div class="card bg-body-tertiary p-3">
                            <h6 class="text-muted mb-3">গ্লোবাল ডেটা ফিল্টার (আপনার নির্ধারিত জেলা)</h6>
                            <p class="small text-muted">একটি জেলা নির্বাচন করলে শুধুমাত্র সেই জেলার জন্য ডেটা দেখানো হবে এবং এই সেটিংটি আপনার অ্যাকাউন্টের জন্য লক হয়ে যাবে। অন্য অ্যাডমিনরা এই জেলাটি আর নির্বাচন করতে পারবেন না।</p>
                            <div class="input-group">
                                <input class="form-control" list="districtOptions" id="districtFilterInput" placeholder="জেলা খুঁজুন বা নির্বাচন করুন...">
                                <datalist id="districtOptions">
                                    <!-- Options will be populated by JS -->
                                </datalist>
                                <button class="btn btn-success" type="button" id="btnApplyDistrictFilter">ফিল্টার প্রয়োগ ও সেভ করুন</button>
                                <button class="btn btn-secondary d-none" type="button" id="btnClearDistrictFilter">ফিল্টার ক্লিয়ার</button>
                            </div>
                            <div id="filterStatus" class="mt-2 small d-none"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // IMPORTANT: Use your own Firebase config here
        const firebaseConfig = {
            apiKey: "AIzaSyBnKQr2k2ZWnPlEZiJtMDewv6z3Z7p3kiU",
            authDomain: "pacheacchi.firebaseapp.com",
            projectId: "pacheacchi",
            storageBucket: "pacheacchi.appspot.com",
            messagingSenderId: "679996219070",
            appId: "1:679996219070:web:871b64fb4a5be296eac8ef",
            measurementId: "G-M34YKMYHQ8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginSection = document.getElementById('loginSection');
        const mainApp = document.getElementById('mainApp');
        const loadingSpinner = document.getElementById('loadingSpinner');

        let editingNewsId = null;
        let editingContactDBId = null;
        let currentCLState = { category: '', division: '', district: '', upazila: '' };
        let contactModal = null;
        let adminConfig = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                showApp(user);
            } else {
                showLogin();
            }
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const errorMsg = document.getElementById('loginError');

            if(!email || !pass) {
                errorMsg.innerText = "দয়া করে ইমেইল এবং পাসওয়ার্ড দিন";
                return;
            }

            loadingSpinner.style.display = 'block';
            errorMsg.innerText = '';

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                console.error(error);
                errorMsg.innerText = "ভুল তথ্য! অথবা পারমিশন নেই।";
            } finally {
                loadingSpinner.style.display = 'none';
            }
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.reload();
            }).catch((error) => {
                console.error(error);
            });
        });

        function showLogin() {
            loginSection.classList.remove('d-none');
            mainApp.classList.add('d-none');
            mainApp.classList.remove('d-flex-wrapper');
        }

        async function showApp(user) {
            loginSection.classList.add('d-none');
            mainApp.classList.remove('d-none');
            mainApp.classList.add('d-flex-wrapper');
            document.getElementById('displayUsername').innerText = user.email.split('@')[0];
            contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
            
            // Check for admin district configuration
            const adminConfigRef = doc(db, "admin_config", user.uid);
            const docSnap = await getDoc(adminConfigRef);

            if (docSnap.exists() && docSnap.data().lockedDistrict) {
                adminConfig = docSnap.data();
                window.globalDistrictFilter = adminConfig.lockedDistrict;
                // Load default page for existing configured admin
                showPage('terms', document.querySelector('#sidebar a[onclick*="terms"]'));
                updateFilterStatusUI();
                window.populateDistrictFilter(user.uid); 
            } else {
                // New admin or district not set
                alert("স্বাগতম! অ্যাডমিন হিসেবে কাজ শুরু করার জন্য, অনুগ্রহ করে আপনার কাজের জেলা নির্বাচন করুন।");
                toggleMenuLock(true); // Lock menu items
                // Force user to settings page after security check
                const settingsElement = document.querySelector('#sidebar a[onclick*="settings"]');
                promptForSettings(settingsElement, true);
                document.getElementById('firstTimeSetupMsg').classList.remove('d-none');
                window.populateDistrictFilter(user.uid);
            }
        }
        
        // This function will enable/disable sidebar menu items
        function toggleMenuLock(isLocked) {
            document.querySelectorAll('a[data-menu-item="true"]').forEach(link => {
                if(isLocked) {
                    link.classList.add('disabled-link');
                } else {
                    link.classList.remove('disabled-link');
                }
            });
        }
        
        function updateFilterStatusUI() {
            const filterStatus = document.getElementById('filterStatus');
            const districtInput = document.getElementById('districtFilterInput');
            const applyBtn = document.getElementById('btnApplyDistrictFilter');

            if(window.globalDistrictFilter){
                filterStatus.innerHTML = `বর্তমান নির্ধারিত জেলা: <span class="badge bg-primary fs-6">${window.globalDistrictFilter}</span>`;
                filterStatus.classList.remove('d-none');
                districtInput.value = window.globalDistrictFilter;
                districtInput.disabled = true;
                applyBtn.disabled = true;
                applyBtn.innerText = "জেলা নির্ধারিত";
            }
        }

        async function loadNewsList() {
            const tbody = document.getElementById('newsTableBody');
            tbody.innerHTML = '';
            try {
                const snap = await getDocs(collection(db, "news"));
                if(snap.empty) {
                     tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">কোন নিউজ পাওয়া যায়নি</td></tr>';
                     return;
                }
                snap.forEach(doc => {
                    const d = doc.data();
                    const tr = document.createElement('tr');
                    const dataStr = encodeURIComponent(JSON.stringify(d));
                    
                    tr.innerHTML = `
                        <td>${d.date || '-'}</td>
                        <td>${d.title}</td>
                        <td><small>${d.content ? d.content.substring(0, 50) + '...' : ''}</small></td>
                        <td>
                            <span class="badge bg-warning text-dark action-btn" onclick="editNews('${doc.id}', '${dataStr}')"><i class="fas fa-edit"></i></span>
                            <span class="badge bg-danger action-btn" onclick="deleteDocById('news', '${doc.id}')"><i class="fas fa-trash"></i></span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); }
        }

        document.getElementById('btnPublishNews').addEventListener('click', async () => {
            const title = document.getElementById('newsTitle').value;
            const date = document.getElementById('newsDate').value;
            const img = document.getElementById('newsImg').value;
            const desc = document.getElementById('newsDesc').value;

            if(!title) return alert("শিরোনাম দিন!");

            try {
                if(editingNewsId) {
                    await updateDoc(doc(db, "news", editingNewsId), {
                        title: title, date: date, imageUrl: img, content: desc, updatedAt: new Date()
                    });
                    alert("নিউজ আপডেট হয়েছে!");
                    resetNewsForm();
                } else {
                    await addDoc(collection(db, "news"), {
                        title: title, date: date, imageUrl: img, content: desc, createdAt: new Date()
                    });
                    alert("নিউজ পাবলিশ হয়েছে!");
                    document.getElementById('newsTitle').value = "";
                    document.getElementById('newsDate').value = "";
                    document.getElementById('newsImg').value = "";
                    document.getElementById('newsDesc').value = "";
                }
                loadNewsList();
            } catch (e) { alert("এরর: " + e.message); }
        });

        window.editNews = (id, dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingNewsId = id;
            document.getElementById('newsTitle').value = data.title || '';
            document.getElementById('newsDate').value = data.date || '';
            document.getElementById('newsImg').value = data.imageUrl || '';
            document.getElementById('newsDesc').value = data.content || '';
            
            document.getElementById('newsFormTitle').innerText = "নিউজ আপডেট করুন";
            document.getElementById('btnPublishNews').innerText = "আপডেট করুন";
            document.getElementById('btnPublishNews').classList.replace('btn-primary', 'btn-warning');
            document.getElementById('btnCancelEditNews').classList.remove('d-none');
            window.scrollTo(0, 0);
        };

        document.getElementById('btnCancelEditNews').addEventListener('click', resetNewsForm);

        function resetNewsForm() {
            editingNewsId = null;
            document.getElementById('newsTitle').value = "";
            document.getElementById('newsDate').value = "";
            document.getElementById('newsImg').value = "";
            document.getElementById('newsDesc').value = "";
            document.getElementById('newsFormTitle').innerText = "নতুন নিউজ পাবলিশ করুন";
            document.getElementById('btnPublishNews').innerHTML = '<i class="fas fa-paper-plane me-2"></i>পাবলিশ করুন';
            document.getElementById('btnPublishNews').classList.replace('btn-warning', 'btn-primary');
            document.getElementById('btnCancelEditNews').classList.add('d-none');
        }

        async function loadUserList() {
            const tbody = document.getElementById('usersTableBody');
            const noUsersMsg = document.getElementById('noUsersMsg');
            tbody.innerHTML = '';
            noUsersMsg.classList.add('d-none');

            try {
                let userQuery;
                if (window.globalDistrictFilter) {
                    userQuery = query(collection(db, "users"), where("district", "==", window.globalDistrictFilter));
                } else {
                    noUsersMsg.innerText = "অনুগ্রহ করে প্রথমে সেটিংস থেকে একটি জেলা নির্ধারণ করুন।";
                    noUsersMsg.classList.remove('d-none');
                    return;
                }

                const querySnapshot = await getDocs(userQuery);
                
                if (querySnapshot.empty) {
                    noUsersMsg.innerText = `${window.globalDistrictFilter} জেলায় কোন ইউজার পাওয়া যায়নি`;
                    noUsersMsg.classList.remove('d-none');
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const upazilaInfo = data.upazila ? `, ${data.upazila}` : '';
                    const row = `
                        <tr>
                            <td>
                                <div>${data.email || data.name || 'Unknown'}</div>
                                <small class="text-muted">${data.district || 'জেলা নেই'}${upazilaInfo}</small>
                            </td>
                            <td>${data.mobile || data.phone || 'N/A'}</td>
                            <td><span class="badge bg-secondary">${doc.id.substring(0, 8)}...</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">ডাটা লোড করা যায়নি। Error: ${e.message}</td></tr>`;
                console.error("Error loading users: ", e);
            }
        }
        
        document.getElementById('userSearchInput').addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            document.querySelectorAll('#usersTableBody tr').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
            });
        });

        document.getElementById('btnRefreshUsers').addEventListener('click', loadUserList);
        window.loadUserListRef = loadUserList; 

        window.loadContactListDB = async (category, division, district, upazila) => {
            const listContainer = document.getElementById('finalContactList');
            const loader = document.getElementById('clLoading');
            
            listContainer.innerHTML = '';
            loader.classList.remove('d-none');
            currentCLState = { category, division, district, upazila };

            try {
                const q = query(collection(db, "contacts"), where("category", "==", category), where("division", "==", division), where("district", "==", district), where("upazila", "==", upazila));
                const querySnapshot = await getDocs(q);
                
                loader.classList.add('d-none');

                if(querySnapshot.empty) {
                    listContainer.innerHTML = '<div class="text-center text-muted py-4">এই লোকেশনে কোন ডাটা পাওয়া যায়নি।</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    const dataStr = encodeURIComponent(JSON.stringify(d));
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center mb-2 shadow-sm border rounded';
                    const cleanDetails = d.details ? d.details.replace(' | ', ', ') : '';

                    item.innerHTML = `
                        <div>
                            <h6 class="mb-1 fw-bold">${d.name}</h6>
                            <div class="small text-muted"><i class="fas fa-phone-alt me-1"></i> ${d.phone}</div>
                            ${cleanDetails ? `<div class="small text-muted"><i class="fas fa-info-circle me-1"></i> ${cleanDetails}</div>` : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning" onclick="editContactDB('${doc.id}', '${dataStr}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteContactDB('${doc.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });

            } catch(e) {
                loader.classList.add('d-none');
                listContainer.innerHTML = `<div class="alert alert-danger">ডাটা লোড করতে সমস্যা: ${e.message}</div>`;
                console.error(e);
            }
        };

        document.getElementById('btnSaveContactDB').addEventListener('click', async () => {
            const oName = document.getElementById('modalOfficeName').value;
            const pName = document.getElementById('modalPersonName').value;
            const mob = document.getElementById('modalPhone').value;
            const mail = document.getElementById('modalEmail').value;

            if(!oName || !mob) return alert("প্রতিষ্ঠান নাম এবং ফোন নম্বর আবশ্যক");

            let detailsParts = [];
            if(pName) detailsParts.push(pName);
            if(mail) detailsParts.push(mail);
            const detailsStr = detailsParts.join(" | ");

            const dataPayload = {
                name: oName, phone: mob, details: detailsStr,
                category: currentCLState.category, division: currentCLState.division,
                district: currentCLState.district, upazila: currentCLState.upazila,
                updatedAt: new Date()
            };

            try {
                if(editingContactDBId) {
                    await updateDoc(doc(db, "contacts", editingContactDBId), dataPayload);
                    alert("আপডেট সফল হয়েছে!");
                } else {
                    dataPayload.createdAt = new Date();
                    dataPayload.source = "admin_panel";
                    await addDoc(collection(db, "contacts"), dataPayload);
                    alert("যুক্ত সফল হয়েছে!");
                }
                
                contactModal.hide();
                resetContactModal();
                window.loadContactListDB(currentCLState.category, currentCLState.division, currentCLState.district, currentCLState.upazila);

            } catch(e) { alert("এরর: " + e.message); }
        });

        window.editContactDB = (id, dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            editingContactDBId = id;
            
            document.getElementById('modalCategory').value = data.category || '';
            document.getElementById('modalDivision').value = data.division || '';
            document.getElementById('modalDistrict').value = data.district || '';
            document.getElementById('modalUpazila').value = data.upazila || '';
            document.getElementById('modalOfficeName').value = data.name || '';
            document.getElementById('modalPhone').value = data.phone || '';
            
            let pName = "", email = "";
            if(data.details) {
                const parts = data.details.split(" | ");
                pName = parts[0] || "";
                email = parts[1] || "";
                if(pName.includes('@') && !email) { email = pName; pName = ""; } 
            }
            document.getElementById('modalPersonName').value = pName;
            document.getElementById('modalEmail').value = email;
            
            document.getElementById('contactModalTitle').innerText = "কন্টাক্ট এডিট করুন";
            document.getElementById('btnSaveContactDB').innerText = "আপডেট";
            contactModal.show();
        };

        window.deleteContactDB = async (id) => {
            if(confirm("আপনি কি নিশ্চিত এই কন্টাক্টটি মুছে ফেলতে চান?")) {
                try {
                    await deleteDoc(doc(db, "contacts", id));
                    window.loadContactListDB(currentCLState.category, currentCLState.division, currentCLState.district, currentCLState.upazila);
                } catch(e) { alert("এরর: " + e.message); }
            }
        };

        window.openContactModal = () => {
            resetContactModal();
            document.getElementById('modalCategory').value = currentCLState.category;
            document.getElementById('modalDivision').value = currentCLState.division;
            document.getElementById('modalDistrict').value = currentCLState.district;
            document.getElementById('modalUpazila').value = currentCLState.upazila;
            contactModal.show();
        };

        function resetContactModal() {
            editingContactDBId = null;
            document.getElementById('contactForm').reset();
            document.getElementById('contactModalTitle').innerText = "নতুন কন্টাক্ট যুক্ত করুন";
            document.getElementById('btnSaveContactDB').innerText = "সেভ করুন";
        }

        window.deleteDocById = async (collectionName, docId) => {
            if(confirm("মুছে ফেলতে চান?")) {
                await deleteDoc(doc(db, collectionName, docId));
                if(collectionName === 'news') loadNewsList();
            }
        };

        window.loadNewsData = loadNewsList;
        
        // --- Settings Page Logic (Firebase part) ---
        
        window.db = db; // Make db accessible to the other script
        window.auth = auth;
        window.setDoc = setDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.collection = collection;
        window.toggleMenuLock = toggleMenuLock;
        window.updateFilterStatusUI = updateFilterStatusUI;

    </script>

    <!-- UI Logic Script -->
    <script>
        // Global variable for filtering
        window.globalDistrictFilter = null;

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('show', sidebar.classList.contains('active'));
        }

        function showPage(pageId, element) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
            const target = document.getElementById(pageId);
            if (target) {
                target.classList.remove('d-none', 'fade-in');
                void target.offsetWidth;
                target.classList.add('fade-in');
            }

            if(element) {
                document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active-link'));
                element.classList.add('active-link');
                if (window.innerWidth < 768) toggleSidebar();
            }

            // Trigger data load for specific pages
            if(pageId === 'userlist' && window.loadUserListRef) window.loadUserListRef();
            if(pageId === 'updates' && window.loadNewsData) window.loadNewsData();
            if(pageId === 'contactlist') initContactList();
        }

        // Modified: Security prompt for settings
        function promptForSettings(element, isFirstSetup = false) {
            const securityKey = "12345678"; // The hardcoded 8-digit security key
            const userInput = prompt("সেটিংস এ প্রবেশ করতে ৮-সংখ্যার সিকিউরিটি কী দিন:");

            if (userInput === null) {
                // User cancelled the prompt
                if(isFirstSetup) {
                    alert("জেলা নির্ধারণ করা আবশ্যক। অনুগ্রহ করে আবার চেষ্টা করুন।");
                }
                return;
            }

            if (userInput === securityKey) {
                showPage('settings', element);
            } else {
                alert("সিকিউরিটি কী সঠিক নয়!");
                if(isFirstSetup) {
                   // signOut(auth); // Optionally log out user if they can't provide key on first setup
                }
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('themeBtn');
            const icon = btn.querySelector('i');
            const isDark = html.getAttribute('data-bs-theme') === 'dark';
            html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
            icon.classList.toggle('fa-moon', isDark);
            icon.classList.toggle('fa-sun', !isDark);
            btn.classList.toggle('btn-outline-secondary', isDark);
            btn.classList.toggle('btn-outline-warning', !isDark);
        }

        // --- CONTACT LIST LOGIC (Data and Functions) ---
        // CORRECTED: Full Geo Data for Bangladesh
        const bdGeoData = {
            "Dhaka": {
                "Dhaka": ["Savar", "Dhamrai", "Keraniganj", "Nawabganj", "Dohar", "Hazaribagh", "Ramna", "Tejgaon", "Gulshan", "Mirpur", "Pallabi", "Kafrul", "Cantonment", "Uttara", "Mohammadpur", "Dhanmondi", "Badda", "Khilkhet", "Demra", "Jatrabari", "Lalbagh", "Kotwali", "Sutrapur"],
                "Gazipur": ["Gazipur Sadar", "Kaliakair", "Kapasia", "Sreepur", "Kaliganj"],
                "Narayanganj": ["Narayanganj Sadar", "Bandar", "Araihazar", "Rupganj", "Sonargaon"],
                "Manikganj": ["Manikganj Sadar", "Singair", "Saturia", "Shivalaya", "Ghior", "Daulatpur", "Harirampur"],
                "Munshiganj": ["Munshiganj Sadar", "Tongibari", "Sreenagar", "Lohajang", "Gajaria", "Sirajdikhan"],
                "Narsingdi": ["Narsingdi Sadar", "Belabo", "Monohardi", "Palash", "Raipura", "Shibpur"],
                "Tangail": ["Tangail Sadar", "Sakhipur", "Basail", "Madhupur", "Ghatail", "Kalihati", "Nagarpur", "Mirzapur", "Gopalpur", "Delduar", "Bhuapur", "Dhanbari"],
                "Kishoreganj": ["Kishoreganj Sadar", "Hossainpur", "Pakundia", "Katiadi", "Karimganj", "Tarail", "Itna", "Mithamoin", "Austagram", "Nikli", "Bajitpur", "Kuliarchar", "Bhairab"],
                "Faridpur": ["Faridpur Sadar", "Boalmari", "Alfadanga", "Madhukhali", "Bhanga", "Nagarkanda", "Charbhadrasan", "Sadarpur", "Saltha"],
                "Gopalganj": ["Gopalganj Sadar", "Kashiani", "Tungipara", "Kotalipara", "Muksudpur"],
                "Madaripur": ["Madaripur Sadar", "Kalkini", "Rajoir", "Shibchar"],
                "Rajbari": ["Rajbari Sadar", "Goalanda", "Pangsa", "Baliakandi", "Kalukhali"],
                "Shariatpur": ["Shariatpur Sadar", "Naria", "Zajira", "Gosairhat", "Bhedarganj", "Damudya"]
            },
            "Chittagong": {
                "Chittagong": ["Chittagong Sadar", "Sitakunda", "Mirsharai", "Patiya", "Rangunia", "Anwara", "Boalkhali", "Raozan", "Hathazari", "Fatikchhari", "Sandwip", "Lohagara", "Satkania", "Banshkhali", "Chandanaish", "Karnaphuli"],
                "Cox's Bazar": ["Cox's Bazar Sadar", "Chakaria", "Kutubdia", "Ukhiya", "Moheshkhali", "Pekua", "Ramu", "Teknaf"],
                "Comilla": ["Comilla Sadar", "Barura", "Brahmanpara", "Burichong", "Chandina", "Chauddagram", "Daudkandi", "Debidwar", "Homna", "Laksam", "Muradnagar", "Nangalkot", "Meghna", "Titas", "Monohargonj", "Lalmai"],
                "Brahmanbaria": ["Brahmanbaria Sadar", "Kasba", "Nasirnagar", "Sarail", "Ashuganj", "Akhaura", "Nabinagar", "Bancharampur", "Bijoynagar"],
                "Chandpur": ["Chandpur Sadar", "Faridganj", "Haimchar", "Haziganj", "Kachua", "Matlab North", "Matlab South", "Shahrasti"],
                "Noakhali": ["Noakhali Sadar", "Begumganj", "Chatkhil", "Companyganj", "Hatiya", "Senbagh", "Sonaimuri", "Subarnachar", "Kabirhat"],
                "Feni": ["Feni Sadar", "Chhagalnaiya", "Daganbhuiyan", "Parshuram", "Fulgazi", "Sonagazi"],
                "Lakshmipur": ["Lakshmipur Sadar", "Raipur", "Ramganj", "Ramgati", "Kamalnagar"],
                "Khagrachhari": ["Khagrachhari Sadar", "Dighinala", "Panchhari", "Laxmichhari", "Mahalchhari", "Manikchhari", "Ramgarh", "Matiranga", "Guimara"],
                "Rangamati": ["Rangamati Sadar", "Belaichhari", "Bagaichhari", "Barkal", "Juraichhari", "Rajasthali", "Kaptai", "Langadu", "Naniarchar", "Kaukhali"],
                "Bandarban": ["Bandarban Sadar", "Ali Kadam", "Naikhongchhari", "Rowangchhari", "Lama", "Ruma", "Thanchi"]
            },
            "Sylhet": {
                "Sylhet": ["Sylhet Sadar", "Beanibazar", "Bishwanath", "Dakshin Surma", "Balaganj", "Companiganj", "Fenchuganj", "Golapganj", "Gowainghat", "Jaintiapur", "Kanaighat", "Zakiganj", "Osmani Nagar"],
                "Moulvibazar": ["Moulvibazar Sadar", "Barlekha", "Juri", "Kamalganj", "Kulaura", "Rajnagar", "Sreemangal"],
                "Habiganj": ["Habiganj Sadar", "Azmiriganj", "Bahubal", "Baniyachong", "Chunarughat", "Lakhai", "Madhabpur", "Nabiganj", "Shayestaganj"],
                "Sunamganj": ["Sunamganj Sadar", "Bishwamvarpur", "Chhatak", "Derai", "Dharamapasha", "Dowarabazar", "Jagannathpur", "Jamalganj", "Tahirpur", "Sullah", "Shantiganj"]
            },
            "Rajshahi": {
                "Rajshahi": ["Rajshahi Sadar", "Bagha", "Bagmara", "Charghat", "Durgapur", "Godagari", "Mohanpur", "Paba", "Puthia", "Tanore"],
                "Bogra": ["Bogra Sadar", "Adamdighi", "Dhupchanchia", "Gabtali", "Kahaloo", "Nandigram", "Sariakandi", "Sahajanpur", "Sherpur", "Shibganj", "Sonatala"],
                "Naogaon": ["Naogaon Sadar", "Atrai", "Badalgachhi", "Dhamoirhat", "Manda", "Mohadevpur", "Niamatpur", "Patnitala", "Porsha", "Raninagar", "Sapahar"],
                "Natore": ["Natore Sadar", "Bagatipara", "Baraigram", "Gurudaspur", "Lalpur", "Singra", "Naldanga"],
                "Chapainawabganj": ["Chapainawabganj Sadar", "Gomastapur", "Nachole", "Bholahat", "Shibganj"],
                "Pabna": ["Pabna Sadar", "Atgharia", "Bera", "Bhangura", "Chatmohar", "Faridpur", "Ishwardi", "Santhia", "Sujanagar"],
                "Sirajganj": ["Sirajganj Sadar", "Belkuchi", "Chauhali", "Kamarkhanda", "Kazipur", "Raiganj", "Shahjadpur", "Tarash", "Ullahpara"],
                "Joypurhat": ["Joypurhat Sadar", "Akkelpur", "Kalai", "Khetlal", "Panchbibi"]
            },
            "Khulna": {
                "Khulna": ["Khulna Sadar", "Batiaghata", "Dacope", "Dumuria", "Dighalia", "Koyra", "Paikgachha", "Phultala", "Rupsha", "Terokhada"],
                "Bagerhat": ["Bagerhat Sadar", "Chitalmari", "Fakirhat", "Kachua", "Mollahat", "Mongla", "Morrelganj", "Rampal", "Sarankhola"],
                "Chuadanga": ["Chuadanga Sadar", "Alamdanga", "Damurhuda", "Jibannagar"],
                "Jessore": ["Jessore Sadar", "Abhaynagar", "Bagherpara", "Chaugachha", "Jhikargachha", "Keshabpur", "Manirampur", "Sharsha"],
                "Jhenaidah": ["Jhenaidah Sadar", "Harinakunda", "Kaliganj", "Kotchandpur", "Maheshpur", "Shailkupa"],
                "Kushtia": ["Kushtia Sadar", "Bheramara", "Daulatpur", "Khoksa", "Kumarkhali", "Mirpur"],
                "Magura": ["Magura Sadar", "Mohammadpur", "Shalikha", "Sreepur"],
                "Meherpur": ["Meherpur Sadar", "Gangni", "Mujibnagar"],
                "Narail": ["Narail Sadar", "Kalia", "Lohagara"],
                "Satkhira": ["Satkhira Sadar", "Assasuni", "Debhata", "Kalaroa", "Kaliganj", "Shyamnagar", "Tala"]
            },
            "Barisal": {
                "Barisal": ["Barisal Sadar", "Agailjhara", "Babuganj", "Bakerganj", "Banaripara", "Gaurnadi", "Hizla", "Mehendiganj", "Muladi", "Wazirpur"],
                "Barguna": ["Barguna Sadar", "Amtali", "Bamna", "Betagi", "Patharghata", "Taltali"],
                "Bhola": ["Bhola Sadar", "Burhanuddin", "Char Fasson", "Daulatkhan", "Lalmohan", "Manpura", "Tazumuddin"],
                "Jhalokati": ["Jhalokati Sadar", "Kathalia", "Nalchity", "Rajapur"],
                "Patuakhali": ["Patuakhali Sadar", "Bauphal", "Dashmina", "Galachipa", "Kalapara", "Mirzaganj", "Rangabali", "Dumki"],
                "Pirojpur": ["Pirojpur Sadar", "Bhandaria", "Kawkhali", "Mathbaria", "Nazirpur", "Nesarabad", "Indurkani"]
            },
            "Rangpur": {
                "Rangpur": ["Rangpur Sadar", "Badarganj", "Gangachhara", "Kaunia", "Mithapukur", "Pirgachha", "Pirganj", "Taraganj"],
                "Dinajpur": ["Dinajpur Sadar", "Birampur", "Birganj", "Bochaganj", "Chirirbandar", "Fulbari", "Ghoraghat", "Hakimpur", "Kaharole", "Khansama", "Nawabganj", "Parbatipur", "Birol"],
                "Gaibandha": ["Gaibandha Sadar", "Fulchhari", "Gobindaganj", "Palashbari", "Sadullapur", "Saghata", "Sundarganj"],
                "Kurigram": ["Kurigram Sadar", "Bhurungamari", "Char Rajibpur", "Chilmari", "Phulbari", "Nageshwari", "Rajarhat", "Raomari", "Ulipur"],
                "Lalmonirhat": ["Lalmonirhat Sadar", "Aditmari", "Hatibandha", "Kaliganj", "Patgram"],
                "Nilphamari": ["Nilphamari Sadar", "Dimla", "Domar", "Jaldhaka", "Kishoreganj", "Saidpur"],
                "Panchagarh": ["Panchagarh Sadar", "Atwari", "Boda", "Debiganj", "Tetulia"],
                "Thakurgaon": ["Thakurgaon Sadar", "Baliadangi", "Haripur", "Pirganj", "Ranishankail"]
            },
            "Mymensingh": {
                "Mymensingh": ["Mymensingh Sadar", "Bhaluka", "Dhobaura", "Fulbaria", "Gafargaon", "Gauripur", "Haluaghat", "Ishwarganj", "Muktagachha", "Nandail", "Phulpur", "Trishal", "Tara Khanda"],
                "Jamalpur": ["Jamalpur Sadar", "Baksiganj", "Dewanganj", "Islampur", "Madarganj", "Melandaha", "Sarishabari"],
                "Netrokona": ["Netrokona Sadar", "Atpara", "Barhatta", "Durgapur", "Khaliajuri", "Kalmakanda", "Kendua", "Madan", "Mohanganj", "Purbadhala"],
                "Sherpur": ["Sherpur Sadar", "Jhenaigati", "Nakla", "Nalitabari", "Sreebardi"]
            }
        };

        const clCategories = [
            { id: 'police', name: 'পুলিশ স্টেশন', icon: 'fa-user-shield' },
            { id: 'hospital', name: 'হাসপাতাল', icon: 'fa-hospital' },
            { id: 'ambulance', name: 'এম্বুলেন্স', icon: 'fa-ambulance' },
            { id: 'electricity', name: 'বিদ্যুৎ জোনাল অফিস', icon: 'fa-bolt' },
            { id: 'fire', name: 'ফায়ার সার্ভিস', icon: 'fa-fire-extinguisher' },
            { id: 'gas', name: 'গ্যাস ফিলিং স্টেশন', icon: 'fa-burn' },
            { id: 'wasa', name: 'ওয়াসা', icon: 'fa-tint' },
            { id: 'petrol', name: 'পেট্রোল পাম্প', icon: 'fa-gas-pump' },
            { id: 'govt', name: 'সরকারী কার্যালয়', icon: 'fa-landmark' }
        ];

        let clState = { step: 0, category: '', division: '', district: '', upazila: '' };

        function initContactList() {
            if (window.globalDistrictFilter) {
                let divisionName = '';
                let districtName = window.globalDistrictFilter;
                // Find the division for the selected district
                for (const div in bdGeoData) {
                    if (bdGeoData[div].hasOwnProperty(districtName)) {
                        divisionName = div;
                        break;
                    }
                }
                if (divisionName) {
                    clState.division = divisionName;
                    clState.district = districtName;
                    document.getElementById('clTitle').innerText = `${districtName} জেলার জন্য ক্যাটাগরি নির্বাচন করুন`;
                }
            }
            renderCategories();
            goToClStep(0);
        }

        function goToClStep(stepIndex) {
            clState.step = stepIndex;
            document.getElementById('clSlider').style.transform = `translateX(-${stepIndex * 20}%)`;
            const titles = ["ক্যাটাগরি", "বিভাগ", "জেলা", "উপজেলা", "রেজাল্ট / কন্টাক্ট লিস্ট"];
            if (!window.globalDistrictFilter || stepIndex < 3) {
                document.getElementById('clTitle').innerText = titles[stepIndex] + " নির্বাচন করুন";
            }
            document.getElementById('clBackBtn').classList.toggle('d-none', stepIndex <= 0);
        }

        function prevContactStep() {
            if (clState.step > 0) {
                if (window.globalDistrictFilter && clState.step === 3) {
                    goToClStep(0); // Go back to categories from upazila if filter is on
                } else {
                    goToClStep(clState.step - 1);
                }
            }
        }

        function createListItem(text, onClick) {
            const item = document.createElement('div');
            item.className = 'list-group-item cl-item py-3';
            item.innerHTML = text;
            item.onclick = onClick;
            return item;
        }

        function renderCategories() {
            const container = document.getElementById('clCategoryList');
            container.innerHTML = '';
            clCategories.forEach(cat => {
                container.appendChild(createListItem(`<i class="fas ${cat.icon} me-3 text-primary" style="width:20px"></i> ${cat.name}`, () => {
                    clState.category = cat.name;
                    if (window.globalDistrictFilter) {
                        // If filter is active, jump to upazila selection
                        renderUpazilas(clState.division, clState.district);
                        goToClStep(3);
                    } else {
                        // Normal flow
                        renderDivisions();
                        goToClStep(1);
                    }
                }));
            });
        }

        function renderDivisions() {
            const container = document.getElementById('clDivisionList');
            container.innerHTML = '';
            Object.keys(bdGeoData).forEach(div => {
                container.appendChild(createListItem(div + ' বিভাগ', () => {
                    clState.division = div; renderDistricts(div); goToClStep(2);
                }));
            });
        }

        function renderDistricts(divName) {
            const container = document.getElementById('clDistrictList');
            container.innerHTML = '';
            Object.keys(bdGeoData[divName]).forEach(dist => {
                container.appendChild(createListItem(dist + ' জেলা', () => {
                    clState.district = dist; renderUpazilas(divName, dist); goToClStep(3);
                }));
            });
        }

        function renderUpazilas(divName, distName) {
            const container = document.getElementById('clUpazilaList');
            container.innerHTML = '';
            (bdGeoData[divName][distName] || []).forEach(upz => {
                container.appendChild(createListItem(upz, () => {
                    clState.upazila = upz; showResultPage(); goToClStep(4);
                }));
            });
        }

        function showResultPage() {
            document.getElementById('clSelectedBreadcrumb').innerText = `${clState.category} > ${clState.division} > ${clState.district} > ${clState.upazila}`;
            if(window.loadContactListDB) {
                window.loadContactListDB(clState.category, clState.division, clState.district, clState.upazila);
            }
        }
        
        const isValidDistrict = (district) => {
            for (const division in bdGeoData) {
                if (bdGeoData[division].hasOwnProperty(district)) return true;
            }
            return false;
        }

        // --- Settings Page Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const adminNameInput = document.getElementById('adminNameInput');
            const btnSaveAdminName = document.getElementById('btnSaveAdminName');
            const displayUsername = document.getElementById('displayUsername');
            const districtFilterInput = document.getElementById('districtFilterInput');
            const btnApplyFilter = document.getElementById('btnApplyDistrictFilter');

            if (btnSaveAdminName) {
                btnSaveAdminName.addEventListener('click', () => {
                    const newName = adminNameInput.value.trim();
                    if (newName) {
                        displayUsername.innerText = newName;
                        alert('এডমিনের নাম পরিবর্তন করা হয়েছে!');
                        adminNameInput.value = '';
                    } else {
                        alert('অনুগ্রহ করে একটি নাম দিন।');
                    }
                });
            }

            if (btnApplyFilter) {
                btnApplyFilter.addEventListener('click', async () => {
                    const selectedDistrict = districtFilterInput.value.trim();
                    if (selectedDistrict && isValidDistrict(selectedDistrict)) {
                        
                        const currentUser = window.auth.currentUser;
                        if(!currentUser) return alert("ত্রুটি: অ্যাডমিন লগইন পাওয়া যায়নি।");

                        const adminConfigRef = window.doc(window.db, "admin_config", currentUser.uid);

                        try {
                            await window.setDoc(adminConfigRef, { lockedDistrict: selectedDistrict });
                            window.globalDistrictFilter = selectedDistrict;
                            alert(`${selectedDistrict} জেলাটি আপনার জন্য সফলভাবে সেট করা হয়েছে।`);
                            
                            window.toggleMenuLock(false);
                            window.updateFilterStatusUI();
                            document.getElementById('firstTimeSetupMsg').classList.add('d-none');
                            
                            const activePage = document.querySelector('.page-section:not(.d-none)');
                            if (activePage) showPage(activePage.id, document.querySelector(`#sidebar a[onclick*="'${activePage.id}'"]`));
                        
                        } catch(e) {
                            alert("ত্রুটি: জেলা সেট করা যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।");
                            console.error("Error setting district:", e);
                        }

                    } else {
                        alert('অনুগ্রহ করে তালিকা থেকে একটি সঠিক জেলা নির্বাচন করুন।');
                    }
                });
            }
        });
        
        async function populateDistrictFilter(currentAdminUid) {
            const districtOptions = document.getElementById('districtOptions');
            districtOptions.innerHTML = '';
            
            // 1. Get all districts from local data
            const allDistricts = new Set();
            for (const division in bdGeoData) {
                for (const district in bdGeoData[division]) {
                    allDistricts.add(district);
                }
            }

            // 2. Get all locked districts from Firestore
            const lockedDistricts = new Set();
            let currentAdminDistrict = null;
            const querySnapshot = await window.getDocs(window.collection(window.db, "admin_config"));
            querySnapshot.forEach((doc) => {
                if (doc.id === currentAdminUid) {
                    currentAdminDistrict = doc.data().lockedDistrict;
                } else {
                    lockedDistricts.add(doc.data().lockedDistrict);
                }
            });

            // 3. Create available districts list
            const sortedDistricts = Array.from(allDistricts).sort();
            sortedDistricts.forEach(district => {
                // Add district if it's not locked by OTHERS. 
                // The current admin should see their own locked district in the list.
                if (!lockedDistricts.has(district)) {
                    const option = document.createElement('option');
                    option.value = district;
                    districtOptions.appendChild(option);
                }
            });
        }
        window.populateDistrictFilter = populateDistrictFilter;

    </script>
</body>
</html>
